#!/bin/bash
#OpenVPN can be problematic on boot if /etc/default/openvpn has not been altered. This results in openvpn starting , but looking like it has stopped.
#/etc/default/openvpn should have #AUTOSTART="all" uncommented.
#To ensure this has not happened we will stop OpenVPN first to make sure.
service openvpn stop 2>/dev/null

service openvpn start 2>&1
if [ "$?" != 0 ]
then
	sleep 5
fi

Ports="1194"

#Check that the service ports are up
for Port in $Ports
do
	PortCheck=0
	Counter=0
	while [ "$PortCheck" = 0 ]
	do
		#Check if we can see the Port open with netstat and keep looping until the Port is up
		PortCheck=$(netstat -vatupn | grep 'openvpn' | grep -c ":$Port ")
		if [ "$PortCheck" = 0 ]
		then
			sleep 1
			#Give up after 60 seconds
			[ $Counter = 60 ] && exit 101
			let Counter=$Counter+1
		fi
	done	
done
