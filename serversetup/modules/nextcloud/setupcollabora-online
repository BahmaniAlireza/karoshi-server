#!/bin/bash
source /opt/karoshi/server_network/domain_information/domain_name
source /opt/karoshi/serversetup/variables/distro
ALIAS=www

apt-get install -y apt-transport-https ca-certificates curl

curl -fsSL https://yum.dockerproject.org/gpg | sudo apt-key add -

add-apt-repository "deb https://apt.dockerproject.org/repo/ ubuntu-$(lsb_release -cs) main"

apt-get update

#Install docker
apt-get -y install docker-engine

#Test that docker is running correctly
docker run hello-world

#Check that docker worked
if [ $? != 0 ]
then
	echo "There was a problem installing Docker"
fi

#Get collabora for docker
docker pull collabora/code

REALM=$(echo $REALM | sed 's%\.%\\\\\.%g')

#Run collabora
docker run -t -d -p 127.0.0.1:9980:9980 -e 'domain='$ALIAS'\\.'$REALM'' --restart always --cap-add MKNOD collabora/code

#Configure apache to reverse proxy
a2enmod proxy 1>/dev/null
a2enmod proxy_wstunnel 1>/dev/null
a2enmod proxy_http 1>/dev/null

if [ `grep -c "Collabora-Online" /etc/apache2/sites-enabled/default-ssl` = 0 ]
then
	#Remove last lines
	sed -i 's/^<\/VirtualHost>//g' /etc/apache2/sites-enabled/default-ssl
	sed -i 's/^<\/IfModule>//g' /etc/apache2/sites-enabled/default-ssl

	#Add in reverse proxy
	echo -e '
#Reverse Proxy configuration for Collabora-Online
AllowEncodedSlashes NoDecode
# Container uses a unique non-signed certificate
SSLProxyEngine On
SSLProxyVerify None
SSLProxyCheckPeerCN Off
SSLProxyCheckPeerName Off

# keep the host
ProxyPreserveHost On

# static html, js, images, etc. served from loolwsd
# loleaflet is the client part of LibreOffice Online
ProxyPass           /loleaflet https://127.0.0.1:9980/loleaflet retry=0
ProxyPassReverse    /loleaflet https://127.0.0.1:9980/loleaflet

# WOPI discovery URL
ProxyPass           /hosting/discovery https://127.0.0.1:9980/hosting/discovery retry=0
ProxyPassReverse    /hosting/discovery https://127.0.0.1:9980/hosting/discovery

# Main websocket
ProxyPassMatch "/lool/(.*)/ws$" wss://127.0.0.1:9980/lool/$1/ws nocanon

# Admin Console websocket
ProxyPass   /lool/adminws wss://127.0.0.1:9980/lool/adminws

# Download as, Fullscreen presentation and Image upload operations
ProxyPass           /lool https://127.0.0.1:9980/lool
ProxyPassReverse    /lool https://127.0.0.1:9980/lool
' >> /etc/apache2/sites-enabled/default-ssl

	echo "</VirtualHost>" >> /etc/apache2/sites-enabled/default-ssl
	echo "</IfModule>" >> /etc/apache2/sites-enabled/default-ssl
fi

#Restart apache
echo "<ul><li>"Restarting apache to apply kerberos support"</li></ul>"
/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/apache_stop 1>/dev/null
sleep 1
/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/apache_start 1>/dev/null

#Copy in signing authority to libreoffice
cat /etc/ssl/root-ca/cacert.pem >> /var/www/html/nextcloud/resources/config/ca-bundle.crt


#Configure shorewall
MOD_SHOREWALL=no
if [ $(grep -c docker0 /etc/shorewall/interfaces) = 0 ]
then
	MOD_SHOREWALL=yes
	LINENUM=`grep -n 'LAST LINE -- ADD YOUR ENTRIES BEFORE THIS ONE -- DO NOT REMOVE' /etc/shorewall/interfaces | cut -d: -f1`
	sed -i $LINENUM'c'\net'	'docker0'	'detect /etc/shorewall/interfaces
	echo '#'LAST LINE -- ADD YOUR ENTRIES BEFORE THIS ONE -- DO NOT REMOVE >> /etc/shorewall/interfaces

fi

if [ $(grep -c Collabora-Online /etc/shorewall/rules) = 0 ]
then
	MOD_SHOREWALL=yes
	LINENUM=`grep -n 'LAST LINE -- ADD YOUR ENTRIES BEFORE THIS ONE -- DO NOT REMOVE' /etc/shorewall/rules | cut -d: -f1`
	sed -i $LINENUM'c'\ACCEPT'	'net'	'fw'	'tcp'	'9980'	'-'#'Collabora-Online /etc/shorewall/rules
	echo '#'LAST LINE -- ADD YOUR ENTRIES BEFORE THIS ONE -- DO NOT REMOVE >> /etc/shorewall/rules
fi

if [ $MOD_SHOREWALL = yes ]
then
echo '<ul><li>'$"Restarting shorewall"'</li></ul>'
	/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/shorewall_stop 1>/dev/null
	/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/shorewall_start 1>/dev/null
fi
