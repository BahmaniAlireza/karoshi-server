#!/bin/bash

#Copyright (C) 2013  Paul Sharrad
#This program is free software; you can redistribute it and/or
#modify it under the terms of the GNU General Public License
#as published by the Free Software Foundation; either version 2
#of the License, or (at your option) any later version.
#
#This program is distributed in the hope that it will be useful,
#but WITHOUT ANY WARRANTY; without even the implied warranty of
#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#GNU General Public License for more details.
#
#You should have received a copy of the GNU General Public License
#along with this program; if not, write to the Free Software
#Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
#
#The Karoshi Team can be contacted at: 
#mpsharrad@karoshi.org.uk
#jharris@karoshi.org.uk
#aball@karoshi.org.uk
#aloughlin@karoshi.org.uk
#
#Website: http://www.karoshi.org.uk

########################
#Get variables
########################
numArgs=$#
if [ "$numArgs" != 0 ]
then
	echo "$(date): setupnextcloud - incorrect number of arguments<br>"
	exit 101
fi
read -t 3 DATA
DATA=$(echo "$DATA" | tr -cd 'A-Za-z0-9\._:\-/')

REMOTE_USER=$(echo "$DATA" | cut -s -d: -f1)
REMOTE_ADDR=$(echo "$DATA" | cut -s -d: -f2)
#REMOTE_MD5=$(echo "$DATA" | cut -s -d: -f3)
SERVERNAME=$(echo "$DATA" | cut -s -d: -f4)
ALIAS=$(echo "$DATA" | cut -s -d: -f5)

if [ -z "$REMOTE_USER" ]
then
	echo "$(date): setupnextcloud - Blank remote user<br>"
	exit 101
fi
if [ -z "$REMOTE_ADDR" ]
then
	echo "$(date): setupnextcloud - Blank remote tcpip address<br>"
	exit 101
fi
if [ -z "$SERVERNAME" ]
then
	echo "$(date): setupnextcloud - Blank servername<br>"
	exit 101
fi
if [ -z "$ALIAS" ]
then
	echo "$(date): setupnextcloud - Blank alias<br>"
	exit 101
fi

#Ensure that apache and mysql are running on boot
source /opt/karoshi/serversetup/variables/distro
source /opt/karoshi/server_network/domain_information/domain_name

[ -f /opt/karoshi/web_controls/user_prefs/"$REMOTE_USER" ] && source /opt/karoshi/web_controls/user_prefs/"$REMOTE_USER"
export TEXTDOMAIN=karoshi-server

/opt/karoshi/serversetup/distro/"$DISTROCHOICE"/scripts/startonboot/apache
/opt/karoshi/serversetup/distro/"$DISTROCHOICE"/scripts/startonboot/mysql

LDAPSERVER=127.0.0.1
#Get ldap server to use
if [[ $(grep -c -w "kdc" /etc/krb5.conf) -gt 0 ]]
then
	LDAPSERVER=$(grep -w "kdc" /etc/krb5.conf | sed "s/ //g" | sed -n 1,1p | cut -d"=" -f2)
fi

#Extract archive

echo '<ul><li>'$"Extracting Nextcloud"'</li></ul>'
[ -d /var/www/html/nextcloud ] && rm -f -R /var/www/html/nextcloud
tar -xzf /opt/karoshi/serversetup/modules/nextcloud/nextcloud.tar.gz --directory /var/www/html

#Append root cert
cat /etc/ssl/root-ca/cacert.pem >> /var/www/html/nextcloud/resources/config/ca-bundle.crt

#Create data folder for nextcloud
[ ! -d /home/nextcloud/data ] && mkdir -p /home/nextcloud/data
touch /home/nextcloud/data/.ocdata

#Set ownership and permissions
[ ! -d /home/nextcloud/data ] && mkdir -p /home/nextcloud/data
[ ! -d /var/www/html/nextcloud/updater ] && mkdir -p /var/www/html/nextcloud/updater


find /var/www/html/nextcloud/ -type f -print0 | xargs -0 chmod 0640
find /var/www/html/nextcloud/ -type d -print0 | xargs -0 chmod 0750

chown -R root:www-data /var/www/html/nextcloud/
chown -R www-data:www-data  /var/www/html/nextcloud/apps/
chown -R www-data:www-data /var/www/html/nextcloud/config/
chown -R www-data:www-data /home/nextcloud/data/
chown -R www-data:www-data /var/www/html/nextcloud/themes/
chown -R www-data:www-data /var/www/html/nextcloud/updater/

chmod +x /var/www/html/nextcloud/occ

if [ -f /var/www/html/nextcloud/.htaccess ]
then
	chmod 0644 /var/www/html/nextcloud/.htaccess
	chown root:www-data $/var/www/html/nextcloud/.htaccess
fi

echo '# Generated by ownCloud on 2017-01-27 16:59:41
# line below if for Apache 2.4
<ifModule mod_authz_core.c>
Require all denied
</ifModule>

# section for Apache 2.2 and 2.4
IndexIgnore *
' > /home/nextcloud/data/.htaccess

if [ -f /home/nextcloud/data/.htaccess ]
then
	chmod 0644 /home/nextcloud/data/.htaccess
	chown root:www-data /home/nextcloud/data/.htaccess
fi



#Allow htaccess for nextcloud
if [[ $(grep -c "#nextcloud" /etc/apache2/sites-enabled/default-ssl) = 0 ]]
then
	#Remove last lines
	sed -i 's/^<\/VirtualHost>//g' /etc/apache2/sites-enabled/default-ssl
	sed -i 's/^<\/IfModule>//g' /etc/apache2/sites-enabled/default-ssl

	echo -e '	#nextcloud
		<Directory /var/www/html/nextcloud/>
				Options Indexes FollowSymLinks MultiViews
				AllowOverride all
		</Directory>' >> /etc/apache2/sites-enabled/default-ssl
	echo "</VirtualHost>" >> /etc/apache2/sites-enabled/default-ssl
	echo "</IfModule>" >> /etc/apache2/sites-enabled/default-ssl
fi

if [[ $(grep -c "Collabora-Online" /etc/apache2/sites-enabled/default-ssl) = 0 ]]
then
	#Remove last lines
	sed -i 's/^<\/VirtualHost>//g' /etc/apache2/sites-enabled/default-ssl
	sed -i 's/^<\/IfModule>//g' /etc/apache2/sites-enabled/default-ssl

	#Add in reverse proxy
	echo -e '
#Reverse Proxy configuration for Collabora-Online
AllowEncodedSlashes NoDecode
# Container uses a unique non-signed certificate
SSLProxyEngine On
SSLProxyVerify None
SSLProxyCheckPeerCN Off
SSLProxyCheckPeerName Off

# keep the host
ProxyPreserveHost On

# static html, js, images, etc. served from loolwsd
# loleaflet is the client part of LibreOffice Online
ProxyPass           /loleaflet https://127.0.0.1:9980/loleaflet retry=0
ProxyPassReverse    /loleaflet https://127.0.0.1:9980/loleaflet

# WOPI discovery URL
ProxyPass           /hosting/discovery https://127.0.0.1:9980/hosting/discovery retry=0
ProxyPassReverse    /hosting/discovery https://127.0.0.1:9980/hosting/discovery

# Main websocket
ProxyPassMatch "/lool/(.*)/ws$" wss://127.0.0.1:9980/lool/$1/ws nocanon

# Admin Console websocket
ProxyPass   /lool/adminws wss://127.0.0.1:9980/lool/adminws

# Download as, Fullscreen presentation and Image upload operations
ProxyPass           /lool https://127.0.0.1:9980/lool
ProxyPassReverse    /lool https://127.0.0.1:9980/lool
' >> /etc/apache2/sites-enabled/default-ssl

	echo "</VirtualHost>" >> /etc/apache2/sites-enabled/default-ssl
	echo "</IfModule>" >> /etc/apache2/sites-enabled/default-ssl
fi

#Enable mod rewrite and headers
a2enmod rewrite 1>/dev/null
a2enmod headers 1>/dev/null
a2enmod proxy 1>/dev/null
a2enmod proxy_wstunnel 1>/dev/null
a2enmod proxy_http 1>/dev/null

#Restart apache2
echo '<ul><li>'$"Restarting Apache"'</li></ul>'
/opt/karoshi/serversetup/distro/"$DISTROCHOICE"/scripts/control_services/apache_stop 1>/dev/null 2>/dev/null
sleep 1
/opt/karoshi/serversetup/distro/"$DISTROCHOICE"/scripts/control_services/apache_start 1>/dev/null
#####################
#Create nextcloud mysql password for the new database
#####################
echo '<ul><li>'$"Creating mysql database for Nextcloud"'</li></ul>'
CLOUDPASS=$(openssl rand -hex 16)
CLOUDID=$(openssl rand -hex 16)

#############################
#Make sure that we know the root mysql password
#############################

/opt/karoshi/serversetup/all/"useful scripts"/mysql_root_pass

#Get root mysql password
MYSQLPASS=$(sed -n 1,1p /etc/mysql.secret)

#############################
#create and pipe in the database
#############################
mysqladmin -f --password="$MYSQLPASS" drop nextcloud 1>/dev/null 2>/dev/null
sleep 1
mysqladmin --password="$MYSQLPASS" create nextcloud 1>/dev/null
sleep 1

#Create moodule_user in mysql
echo "DROP USER 'nextcloud_user'@'localhost';" > /opt/karoshi/.tempdata/mysqlperms.sql
mysql --password="$MYSQLPASS" < /opt/karoshi/.tempdata/mysqlperms.sql
echo "CREATE USER 'nextcloud_user'@'localhost'  IDENTIFIED BY '$CLOUDPASS';" > /opt/karoshi/.tempdata/mysqlperms.sql
#Grant mysql permissions to nextcloud
echo "GRANT ALL PRIVILEGES ON nextcloud.* TO 'nextcloud_user'@'localhost';" >> /opt/karoshi/.tempdata/mysqlperms.sql
echo 'ALTER DATABASE nextcloud DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;' >> /opt/karoshi/.tempdata/mysqlperms.sql
mysql --password="$MYSQLPASS" < /opt/karoshi/.tempdata/mysqlperms.sql
rm -f /opt/karoshi/.tempdata/mysqlperms.sql

#Modify config.php with the correct password.
sed -i 's/CHANGETHISPASS/'"$CLOUDPASS"'/g' /var/www/html/nextcloud/config/config.php
sed -i 's/CHANGETHISID/'"$CLOUDID"'/g' /var/www/html/nextcloud/config/config.php
sed -i 's/CHANGETHISREALM/'"$ALIAS"'.'"$REALM"'/g' /var/www/html/nextcloud/config/config.php

#Make a backup of nextcloud.sql
cp /opt/karoshi/serversetup/modules/nextcloud/nextcloud.sql /opt/karoshi/serversetup/modules/nextcloud/nextcloud_original.sql

#Edit nextcloud.sql with the correct realm information
sed -i 's@CHANGETHISLDAPBASE@'"$LDAPBASE"'@g' /opt/karoshi/serversetup/modules/nextcloud/nextcloud.sql

#Edit nextcloud.sql with the correct ldap server information ( replace ldap://127.0.0.1 )
if [ "$LDAPSERVER" != 127.0.0.1 ]
then
	sed -i 's/127.0.0.1/'"$LDAPSERVER"'/g' /opt/karoshi/serversetup/modules/nextcloud/nextcloud.sql
fi
#Change the realm for collabora
sed -i 's%https://CHANGETHISREALM%https://'"$ALIAS"'.'"$REALM"'%g' /opt/karoshi/serversetup/modules/nextcloud/nextcloud.sql

#Pipe in database
mysql --password="$MYSQLPASS" nextcloud < /opt/karoshi/serversetup/modules/nextcloud/nextcloud.sql

#Restore original nextcloud.sql
rm -f /opt/karoshi/serversetup/modules/nextcloud/nextcloud.sql
mv /opt/karoshi/serversetup/modules/nextcloud/nextcloud_original.sql /opt/karoshi/serversetup/modules/nextcloud/nextcloud.sql

#Setup collabora-online
echo '<ul><li>'$"Updating repositories"'</li></ul>'
echo '<pre style="font-size: 10pt; font-family:Arial, Times, Georgia, serif">'
apt-get update
echo '</pre>'
echo '<ul><li>'$"Installing apt-transport-https ca-certificates curl"'</li></ul>'
echo '<pre style="font-size: 10pt; font-family:Arial, Times, Georgia, serif">'
apt-get install -y apt-transport-https ca-certificates curl
echo '<ul><li>'$"Adding Docker Repository"'</li></ul>'
echo '</pre>'
curl -fsSL https://yum.dockerproject.org/gpg | sudo apt-key add - 1>/dev/null

add-apt-repository "deb https://apt.dockerproject.org/repo/ ubuntu-$(lsb_release -cs) main"
echo '<ul><li>'$"Updating repositories"'</li></ul>'
echo '<pre style="font-size: 10pt; font-family:Arial, Times, Georgia, serif">'
apt-get update
echo '</pre>'
echo '<ul><li>'$"Installing Docker"'</li></ul>'
#Install docker
echo '<pre style="font-size: 10pt; font-family:Arial, Times, Georgia, serif">'
apt-get -y install docker-engine
echo '</pre>'
#Test that docker is running correctly
echo '<ul><li>'$"Checking that Docker is working"'</li></ul>'
echo '<pre style="font-size: 10pt; font-family:Arial, Times, Georgia, serif">'
docker run hello-world
#Check that docker worked
if [ $? != 0 ]
then
	echo '<ul><li>'$"There was a problem installing Docker"'</li></ul>'
	exit
fi
echo '</pre>'
#Get collabora for docker
echo '<ul><li>'$"Downloading Collabora"' - '$"This will take some time"'</li></ul>'
echo '<pre style="font-size: 10pt; font-family:Arial, Times, Georgia, serif">'
docker pull collabora/code
echo '</pre>'
REALM2=$(echo $REALM | sed 's%\.%\\\\\.%g')

#Run collabora
echo '<ul><li>'$"Starting Collabora"'</li></ul>'
docker run -t -d -p 127.0.0.1:9980:9980 -e 'domain='"$ALIAS"'\\.'"$REALM2"'' --dns=172.17.0.1 --restart always --cap-add MKNOD collabora/code 1> /dev/null

#####################################
#Ensure that apache ports are open in shorewall
#####################################


MOD_SHOREWALL=no
if [[ $(grep -c "#Web-Services" /etc/shorewall/rules) = 0 ]]
then 
	MOD_SHOREWALL=yes
	echo '<ul><li>'$"The following extra ports are being allowed"' - tcp 80,443</li></ul>'
	LINENUM=$(grep -n 'LAST LINE -- ADD YOUR ENTRIES BEFORE THIS ONE -- DO NOT REMOVE' /etc/shorewall/rules | cut -d: -f1)
	sed -i "$LINENUM"'cACCEPT	net	fw	tcp	80,443	-#Web-Services' /etc/shorewall/rules
	echo '#LAST LINE -- ADD YOUR ENTRIES BEFORE THIS ONE -- DO NOT REMOVE' >> /etc/shorewall/rules
fi

if [[ $(grep -c docker0 /etc/shorewall/interfaces) = 0 ]]
then
	MOD_SHOREWALL=yes
	LINENUM=$(grep -n 'LAST LINE -- ADD YOUR ENTRIES BEFORE THIS ONE -- DO NOT REMOVE' /etc/shorewall/interfaces | cut -d: -f1)
	sed -i "$LINENUM"'cnet	docker0	detect' /etc/shorewall/interfaces
	echo '#LAST LINE -- ADD YOUR ENTRIES BEFORE THIS ONE -- DO NOT REMOVE' >> /etc/shorewall/interfaces

fi

if [[ $(grep -c Collabora-Online /etc/shorewall/rules) = 0 ]]
then
	MOD_SHOREWALL=yes
	LINENUM=$(grep -n 'LAST LINE -- ADD YOUR ENTRIES BEFORE THIS ONE -- DO NOT REMOVE' /etc/shorewall/rules | cut -d: -f1)
	sed -i "$LINENUM"'cACCEPT	net	fw	tcp	9980	-#Collabora-Online' /etc/shorewall/rules
	echo '#LAST LINE -- ADD YOUR ENTRIES BEFORE THIS ONE -- DO NOT REMOVE' >> /etc/shorewall/rules
fi

#Make sure we can get to dns which may as well be from the server we are running on since we either have samba4 or dnsmasq
if [[ $(grep -c -w 53 /etc/shorewall/rules) = 0 ]]
then
	MOD_SHOREWALL=yes
	LINENUM=$(grep -n 'LAST LINE -- ADD YOUR ENTRIES BEFORE THIS ONE -- DO NOT REMOVE' /etc/shorewall/rules | cut -d: -f1)
	sed -i "$LINENUM"'cACCEPT	net	fw	tcp	53	-#dnsmasq-tcp' /etc/shorewall/rules
	echo 'ACCEPT	net	fw	udp	53	-#dnsmasq-udp' >> /etc/shorewall/rules
	echo '#LAST LINE -- ADD YOUR ENTRIES BEFORE THIS ONE -- DO NOT REMOVE' >> /etc/shorewall/rules	
fi

if [ "$MOD_SHOREWALL" = yes ]
then
	echo '<ul><li>'$"Restarting shorewall"'</li></ul>'
	/opt/karoshi/serversetup/distro/"$DISTROCHOICE"/scripts/control_services/shorewall_stop 1>/dev/null
	sleep 1
	/opt/karoshi/serversetup/distro/"$DISTROCHOICE"/scripts/control_services/shorewall_start 1>/dev/null
fi

###########################
#Show completed message
###########################
echo '<br>'$"Nextcloud has been installed and can be accessed from" - '<a href="https://'"$ALIAS.$REALM"'/nextcloud" target="_blank">'"$ALIAS.$REALM"'/nextcloud</a>'
echo '<br>'$"username":admin - $"password": admin
echo '<br><p style="font-weight:bold; font-size:20px;">'$"Please change the admin password immediately."'</p><br>'
exit



