//
// Copyright (c) Microsoft Corporation.  All rights reserved.
//

window.Wol||(window.Wol={}),Wol.Search=function(n){"use strict";var s="All",et="Search.NextSessionID",t={market:"m",osDetection:"osd",pageNumber:"p",productFilter:"prd",query:"q",searchSource:"s",spellingCorrection:"spell",version:"v"},o=null,r=null,u={},f={},c={},p;jQuery(function(){tt(),ot(),st(),Wol.Search.BucketBase.initialize(),Wol.Search.SourceFilter.initialize(),y(),it()});var ot=function(){p=$("#SearchResults").data("search-settings")},st=function(){Wol.Util.HashParameters.attachToHashChangeEvent(function(){tt(),y(),it()})},l=function(i,r){i||(i=v()),r===n&&(r=o[t.productFilter]),Wol.Search.BucketBase.selectBucket(i),Wol.Search.SourceFilter.selectFilter(i,r)},ht=function(){if($("body").hasClass("hcDark")){var n=$("img.spglStoreFiveLightStars"),t=$("img.spglStoreFiveDarkStars");n.removeClass("spglStoreFiveLightStars").addClass("spglStoreFiveDarkStars"),t.removeClass("spglStoreFiveDarkStars").addClass("spglStoreFiveLightStars")}},w=function(n){n?(jQuery("#SearchEmptyQueryMessage").show(),e("")):jQuery("#SearchEmptyQueryMessage").hide()},b=function(t,i){var r=jQuery(".SearchScopedSpacer");t?(i!=n&&i==="Store"?r.addClass("SearchScopedSpacerStore"):r.removeClass("SearchScopedSpacerStore"),r.show()):r.hide()},a=function(n,t){for(var u=i("searchSourceNames"),r=1;r<u.length;++r)u[r]!==t&&(d(n,u[r]),k(n,u[r]))},k=function(n,t){n?jQuery("#SearchRenderWrapper"+t).fadeIn(200,"swing"):jQuery("#SearchRenderWrapper"+t).hide()},d=function(n,t){n?jQuery("#BlendedSearchBucketTitle"+t).show():jQuery("#BlendedSearchBucketTitle"+t).hide()},g=function(n,t){var i=function(){jQuery("#SearchInProgress"+t).show(),e("",t),f[t]=null};f[t]&&(clearInterval(f[t]),f[t]=null),n?(f[t]=c[t]?setTimeout(i,1e3):setTimeout(i,0),jQuery("#SearchRenderContainer"+t).attr("aria-busy","true")):(jQuery("#SearchInProgress"+t).hide(),jQuery("#SearchRenderContainer"+t).attr("aria-busy","false"))},nt=function(n,t){n?(jQuery("#SearchConnectionError"+t).fadeIn(200,"swing"),e("",t)):jQuery("#SearchConnectionError"+t).hide()},e=function(n,t){ct(),jQuery("#SearchFocusContainer")[0].focus();var i=jQuery("#SearchRenderContainer"+t);i.html(n),c[t]=Boolean(n),c[t]&&(i.hide(),i.fadeIn(200,"swing")),Wol.Svg.replaceSvgWithPng(i)},i=function(n){return p[n]},ct=function(){jQuery(window).scrollTop(0)},tt=function(){o=Wol.Util.HashParameters.getHash()},it=function(){r=o},h=function(){return jQuery.extend({},o)},rt=function(n){var r=s,u;return n&&(r=n[t.searchSource],u=i("searchSourceNames"),r&&jQuery.inArray(r,u)!==-1||(r=s)),r},lt=function(){return rt(r)},v=function(){return rt(o)},ut=function(){return v()!==lt()},y=function(){var f=h(),n,o,u,r;if(Wol.Search.SearchBoxCoordinator.getInstance().updateQuery(f[t.query]||""),f[t.query])w(!1);else{a(!1),w(!0),l();return}if(Ms.Wol.Cookies!=null&&Ms.Wol.Cookies.SetCookie(et,Wol.Util.Tools.generateGuid(),"",!0),n=v(),o=ut(),l(),n===s)for(b(!1),a(!0),u=i("searchSourceNames"),r=1;r<u.length;++r)o&&e("",u[r]),ft(u[r],!0);else o&&e("",n),b(!0,n),a(!1,n),ft(n,!1)},ft=function(n,f){var s,o,c;k(!0,n),f||d(!1,n),nt(!1,n),g(!0,n),s=f?i("getResultsConciseAshxLocation"):i("getResultsExtendedAshxLocation"),o=h(),o[t.searchSource]=n,o[t.market]||(o[t.market]=i("market")),o[t.pageNumber]||(o[t.pageNumber]=1),o[t.version]||(o[t.version]=i("version")),c=!0,r&&(ut()||r[t.query]!==o[t.query]||r[t.osDetection]!==o[t.osDetection]||r[t.productFilter]!==o[t.productFilter]||r[t.spellingCorrection]!==o[t.spellingCorrection]||(c=!1)),u[n]&&(u[n].readyState!==4&&u[n].abort(),u[n]=null),u[n]=jQuery.ajax({url:s,data:Wol.Util.Tools.toUrlParams(o),timeout:i("ajaxTimeout"),dataType:"json"}).done(function(t){e(t.resultHtml,n),f||l(n,t.effectiveProductFilter),c&&at(n),ht()}).fail(function(t,i){i!=="abort"&&nt(!0,n)}).always(function(t,i){i!=="abort"&&(g(!1,n),u[n]=null)})},at=function(n){jQuery("#SearchRenderContainer"+n+" .SearchBIDataContainer").each(function(){Wol.ContentInstrumentation.Logging.LogCustomBI("Search",null,this)})},vt=function(){y()},yt=function(i){var r=h();return r[t.spellingCorrection]=n,r[t.pageNumber]=n,r[t.searchSource]=i,i===s&&(r[t.searchSource]=n,r[t.productFilter]=n),"#"+Wol.Util.Tools.toUrlParams(r)},pt=function(i){var r=h();return r[t.pageNumber]=n,r[t.productFilter]=i,"#"+Wol.Util.Tools.toUrlParams(r)};return{refreshResults:vt,_getBucketHash:yt,_getProductFilterHash:pt}}(),function(n){"use strict";var r={full:1,compact:2},u=function(n,t){this.topBox=n,this.pageBox=t;var i=window.matchMedia("screen and (max-width: 47.49375em)");this.viewMode=i.matches?r.compact:r.full,i.addListener(e.bind(this)),this._resetBinding(),this.topBox.addEventListener("changed",o.bind(this)),this.pageBox.addEventListener("changed",s.bind(this))},f=function(){this.bindingTo=this.pageBox.initialSetSearchTerm||!this.topBox.initialSetSearchTerm?this.pageBox:this.topBox},e=function(n){var t=n.matches?r.compact:r.full;t!==this.viewMode&&(this.viewMode=t,t==r.full?this.bindingTo===this.pageBox&&(this.pageBox.copyState(this.topBox),this.topBox.clear()):this.bindingTo===this.pageBox&&(this.topBox.copyState(this.pageBox),this.pageBox.clear()))},o=function(){this.isUpdating||this.viewMode===r.full&&this.bindingTo!==this.topBox&&(this.bindingTo=this.topBox)},s=function(){this.isUpdating||this.bindingTo!==this.pageBox&&(this.bindingTo=this.pageBox)},h=function(n){this._resetBinding();var t,i;this.bindingTo===this.topBox||this.viewMode===r.compact?(t=this.topBox,i=this.pageBox):(t=this.pageBox,i=this.topBox),this.isUpdating=!0,t&&t.setSearchTerm(n),i&&i.clear(),delete this.isUpdating},c=function(n){Wol.Search.SearchBoxCoordinator._instance||n.length===2&&(Wol.Search.SearchBoxCoordinator._instance=new Wol.Search.SearchBoxCoordinator(n[0],n[1]))},l=function(){return Wol.Search.SearchBoxCoordinator._instance};n.Namespace.define("Wol.Search",{SearchBoxCoordinator:n.Class.define(u,{updateQuery:h,_resetBinding:f},{initialize:c,getInstance:l})})}(WinJS,jQuery),function(n,t){"use strict";var u=function(){},f=function(){throw"Not Implemented";},r=[],e=function(){var n=t("#SearchBuckets"),i;r.push(new Wol.Search.BucketLinks(n)),i=t("#SearchBucketDropDown"),r.push(new Wol.Search.BucketDropDown(i))},o=function(n){for(var t=0;t<r.length;t++)r[t].select(n)};n.Namespace.define("Wol.Search",{BucketBase:n.Class.define(u,{select:f},{initialize:e,selectBucket:o})})}(WinJS,jQuery),function(n,t){"use strict";var r=function(n){this.$root=n;var r={},i;n.find("a").each(function(){var n=t(this),u=n.data("source-id");r[u]=n,i||(i=n)}),this._links=r,this._seletedLink=i},u=function(n){var i,t;for(i in this._links)this._links.hasOwnProperty(i)&&(t=this._links[i],i===n?(t.addClass("CurrentSource"),t.attr("href","javascript:void(0)"),this._seletedLink=t):(t.removeClass("CurrentSource"),t.attr("href",Wol.Search._getBucketHash(i))))};n.Namespace.define("Wol.Search",{BucketLinks:n.Class.derive(Wol.Search.BucketBase,r,{select:u},{})})}(WinJS,jQuery),function(n,t){"use strict";var r=function(n){this.$root=n,this.$select=n.find("select").first();var r={},i;n.find("option").each(function(){var n=t(this),f=n.attr("value"),e=n.data("display-name"),u={$option:n,displayName:e};r[f]=u,i||(i=u)}),this._options=r,this._selectedOption=i,this.$select.change(u.bind(this))},u=function(){var t=this.$select.prop("value"),i=Wol.Search._getBucketHash(t);window.location.href=i},f=function(n){var t=this._options[n];t&&(t.$option.prop("selected",!0),this._selectedOption=t)};n.Namespace.define("Wol.Search",{BucketDropDown:n.Class.derive(Wol.Search.BucketBase,r,{select:f},{})})}(WinJS,jQuery),function(n){"use strict";var r=function(){},u=function(){throw"Not Implemented";};n.Namespace.define("Wol.Search",{FilterBase:n.Class.define(r,{select:u},{})})}(WinJS,jQuery),function(n,t,i){"use strict";var u=function(n){var i={};n.find("ul.SearchFilterExpand a").each(function(){var n=t(this),r=n.data("filter-id");i[r]={$link:n,defaultExpand:!0}}),n.find("ul.SearchFilterCollapse a").each(function(){var n=t(this),r=n.data("filter-id");i[r]={$link:n,defaultExpand:!1}}),this.$root=n,this._filters=i,this._selectedFilter=null,this.$showMore=n.find(".SearchFilterShowMore").first(),this.$showLess=n.find(".SearchFilterShowLess").first(),this.$showMore.click(r.bind(this,!0)),this.$showLess.click(r.bind(this,!1)),this._expand(!1)},r=function(n,t){this._expand(n),t.preventDefault()},f=function(n){var r,t;n=n||"";for(r in this._filters)this._filters.hasOwnProperty(r)&&(t=this._filters[r],r===n?(this._selectedFilter=t,t.$link.addClass("SearchSelectedFilter"),t.$link.attr("href",Wol.Search._getProductFilterHash(i)),t.defaultExpand||this._expand(!0)):(t.$link.removeClass("SearchSelectedFilter"),t.$link.attr("href",Wol.Search._getProductFilterHash(r))))},e=function(n){var t,i;if(n){this.$showMore.hide(),this.$showLess.show();for(t in this._filters)this._filters.hasOwnProperty(t)&&this._filters[t].$link.show()}else{this.$showMore.show(),this.$showLess.hide();for(t in this._filters)this._filters.hasOwnProperty(t)&&(i=this._filters[t],i.defaultExpand||i===this._selectedFilter||i.$link.hide())}};n.Namespace.define("Wol.Search",{FilterLinks:n.Class.derive(Wol.Search.FilterBase,u,{select:f,_expand:e},{})})}(WinJS,jQuery),function(n,t,i){"use strict";var r=function(n){this.$root=n;var i={};n.find("option").each(function(){var n=t(this),r=n.attr("value");i[r]=n}),this._filters=i,n.change(u.bind(this))},u=function(){var t=this.$root.prop("value"),r;t===""&&(t=i),r=Wol.Search._getProductFilterHash(t),window.location.href=r},f=function(n){n=n||"";var t=this._filters[n];t&&t.prop("selected",!0)};n.Namespace.define("Wol.Search",{FilterDropDown:n.Class.derive(Wol.Search.FilterBase,r,{select:f},{})})}(WinJS,jQuery),function(n,t){"use strict";var f=function(n){var t=[],i,r;this.$root=n,i=n.find(".SearchFilterLinks").first(),r=n.find(".SearchFilterDropDown").first(),t.push(new Wol.Search.FilterLinks(i)),t.push(new Wol.Search.FilterDropDown(r)),this._filters=t},e=function(n){n?(this.$root.addClass("CurrentSource"),this.$root.show()):(this.$root.removeClass("CurrentSource"),this.$root.hide())},o=function(n){for(var t=0;t<this._filters.length;t++)this._filters[t].select(n)},u,r,s=function(){u={},t(".SearchProductFilter").each(function(){var n=t(this),f=n.data("source-id"),i=new Wol.Search.SourceFilter(n);u[f]=i,r||(r=i)})},h=function(n,t){var i=u[n];r&&r.visible(!1),i&&(i.visible(!0),i.selectFilter(t)),r=i};n.Namespace.define("Wol.Search",{SourceFilter:n.Class.define(f,{visible:e,selectFilter:o},{initialize:s,selectFilter:h})})}(WinJS,jQuery);