#!/bin/bash

WARNLIMIT=10
LOGPATH=/var/log/syslog
LOG_DATE=`date +%F`

function report_problems {
if [ ! -z "$FAIL_LIST" ]
then
	#Add in a warning to the web management.
	/opt/karoshi/serversetup/web_controls/scripts/web_management_warn add syslog-$SERVERNAME /cgi-bin/admin/update_karoshi_fm.cgi "$SERVERNAME: "$"Syslog Warning"" - ""/var/log/syslog" 3
	echo `date`: check_logs "$SERVERNAME" - Syslog warning >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
fi

}

for SERVERNAME in `ls /opt/karoshi/server_network/servers/`
do
	echo `date`: check_logs "$SERVERNAME" - checking syslog >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	FAIL_LIST=""
	if [ $SERVERNAME = `hostname-fqdn` ]
	then
		#Check to see if the server has booted in the last 5 minutes.
		UPTIME=`uptime | sed "s/ * / /g" | cut -d" " -f4`
		DO_CHECK=yes
		if [ `echo "$UPTIME" | grep -c ":"` = 0 ]
		then
			#There is no : in the time information so uptime is less than 60 minutes.
			if [ "$UPTIME" -le 6 ]
			then
				#This server has been up for less than 6 minutes so dont check the
				#logs since there will be loads of kernel messages.
				DO_CHECK=no
			fi
		fi

		if [ $DO_CHECK = yes ]
		then
			#Create variables for the last 5 minutes
			for (( i = 5; i >=0; i-- ))
			do
				MIN[$i]=$(date "+%b %d %R" -d "-$i  min")
			done

			SYSLOGDATA=`egrep "${MIN[0]}|${MIN[1]}|${MIN[2]}|${MIN[3]}|${MIN[4]}|${MIN[5]}" "$LOGPATH" | cut -d" " -f5`

			#Check data
			CHECK_LIST="kernel nslcd"
			for CHECK in $CHECK_LIST
			do
				CHECKCOUNT=`echo -e "$SYSLOGDATA" | grep -c $CHECK`
				if [ "$CHECKCOUNT" -ge "$WARNLIMIT" ]
				then
					FAIL_LIST="$FAIL_LIST, $CHECK"
				fi
			done

			#Removing any commas from the front of FAIL_LIST
			FAIL_LIST=`echo "$FAIL_LIST" | sed "s/^, //g"`

			#Report any problems detected
			report_problems
		fi
	else
		FAIL_LIST=$(ssh -o PasswordAuthentication=no -o ConnectTimeout=3 $SERVERNAME '
		#Check to see if the server has booted in the last 5 minutes.
		UPTIME=`uptime | sed "s/ * / /g" | cut -d" " -f4`
		DO_CHECK=yes
		if [ `echo "$UPTIME" | grep -c ":"` = 0 ]
		then
			#There is no : in the time information so uptime is less than 60 minutes.
			if [ "$UPTIME" -le 6 ]
			then
				#This server has been up for less than 6 minutes so dont check the
				#logs since there will be loads of kernel messages.
				DO_CHECK=no
			fi
		fi
		if [ $DO_CHECK = yes ]
		then
			#Create variables for the last 5 minutes
			for (( i = 5; i >=0; i-- ))
			do
				MIN[$i]=$(date "+%b %d %R" -d "-$i  min")
			done

			SYSLOGDATA=`egrep "${MIN[0]}|${MIN[1]}|${MIN[2]}|${MIN[3]}|${MIN[4]}|${MIN[5]}" "'$LOGPATH'" | cut -d" " -f5`

			#Check data
			CHECK_LIST="kernel nslcd"
			for CHECK in $CHECK_LIST
			do
				CHECKCOUNT=`echo -e "$SYSLOGDATA" | grep -c $CHECK`
				if [ "$CHECKCOUNT" -ge "'$WARNLIMIT'" ]
				then
					FAIL_LIST="$FAIL_LIST, $CHECK"
				fi
			done

			#Removing any commas from the front of FAIL_LIST
			FAIL_LIST=`echo "$FAIL_LIST" | sed "s/^, //g"`
			echo "$FAIL_LIST"
		fi
		')
		#Report any problems detected
		report_problems
	fi
done

