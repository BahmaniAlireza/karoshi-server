#!/bin/bash


CREATE_TEMPLATE=no
CREATEPOFILES=yes
LANGLIST="ar+cs+da+de+el+es+fr+hi+he+it+ko+nb+nl+pl+pt+ru+sv+zh"

function createtemplate {
#Create a karoshi server language template
[ -f /opt/karoshi/serversetup/language/karoshi-server.pot ] && rm -f /opt/karoshi/serversetup/language/karoshi-server.pot
grep -l -r "TEXTDOMAIN=karoshi-server" /opt/karoshi/serversetup | sed 's/ /\\ /g' | xargs xgettext -w 200 --no-wrap --copyright-holder="Paul Sharrad" --msgid-bugs-address=mpsharrad@karoshi.org.uk --language="bash" --package-name="Karoshi Server" --no-location -o /opt/karoshi/serversetup/language/karoshi-server.pot -L shell 2>/dev/null

#Replace SOME DESCRIPTIVE TITLE.
sed -i 's/SOME DESCRIPTIVE TITLE./Karoshi Server Language Template/' /opt/karoshi/serversetup/language/karoshi-server.pot 
sed -i 's/Copyright (C) YEAR/Copyright (C) 2014/' /opt/karoshi/serversetup/language/karoshi-server.pot 
sed -i 's/PACKAGE package/karoshi Server package/' /opt/karoshi/serversetup/language/karoshi-server.pot
sed -i 's/FIRST AUTHOR <EMAIL@ADDRESS>, YEAR./Paul Sharrad <mpsharrad@karoshi.org.uk>, 2014./' /opt/karoshi/serversetup/language/karoshi-server.pot
}

function translatetxt {
TRANSDATA=`trs {en=$LANGLIST} "$MSGIDTEXT"`
if [ $? != 0 ]
then
	echo An error has been detected.
	sleep 1
	echo Translating each string individually

	#Translate each language in turn
	for KLANG in `echo $LANGLIST | sed 's/+/ /g'`
	do
		TRANSDATA=`trs {en=$KLANG} "$MSGIDTEXT"`
		echo msgid \""$MSGIDTEXT"\"  >> /opt/karoshi/serversetup/language/$KLANG.po
		echo msgstr \"`echo -e "$TRANSDATA"`\" >> /opt/karoshi/serversetup/language/$KLANG.po
		echo >> /opt/karoshi/serversetup/language/$KLANG.po	
	done
else

	COUNTER=1
	for KLANG in `echo $LANGLIST | sed 's/+/ /g'`
	do
		echo msgid \""$MSGIDTEXT"\"  >> /opt/karoshi/serversetup/language/$KLANG.po
		echo msgstr \"`echo -e "$TRANSDATA" | sed -n $COUNTER,$COUNTER"p"`\" >> /opt/karoshi/serversetup/language/$KLANG.po
		echo >> /opt/karoshi/serversetup/language/$KLANG.po
		let COUNTER=$COUNTER+1
	done
	fi
}

function createpofiles {

rm -f /opt/karoshi/serversetup/language/*.po

#Create header for each language
for KLANG in `echo $LANGLIST | sed 's/+/ /g'`
do
	[ ! -f /opt/karoshi/serversetup/language/$KLANG.po ] && sed -n 1,19p /opt/karoshi/serversetup/language/karoshi-server.pot > /opt/karoshi/serversetup/language/$KLANG.po
	sed -i 's/Language:/Language: '$KLANG'/g' /opt/karoshi/serversetup/language/$KLANG.po
done

for MSGIDDATA in `grep ^msgid /opt/karoshi/serversetup/language/karoshi-server.pot | sed 's/ /___/g'`
do
	MSGIDTEXT=`echo $MSGIDDATA | cut -d'"' -f2 | sed 's/___/ /g'`
	if [[ ! -z "$MSGIDTEXT" ]]
	then
		echo $MSGIDTEXT
		translatetxt
		sleep 0.5
	fi
done
}

[ "$CREATE_TEMPLATE" = yes ] && createtemplate
[ "$CREATEPOFILES" = yes ] && createpofiles

exit








