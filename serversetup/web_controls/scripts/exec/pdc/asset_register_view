#!/bin/bash
#Copyright (C) 2007  Paul Sharrad
#Copyright (C) 2013  Robin McCorkell

#This file is part of Karoshi Server.
#
#Karoshi Server is free software: you can redistribute it and/or modify
#it under the terms of the GNU Affero General Public License as published by
#the Free Software Foundation, either version 3 of the License, or
#(at your option) any later version.
#
#Karoshi Server is distributed in the hope that it will be useful,
#but WITHOUT ANY WARRANTY; without even the implied warranty of
#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#GNU Affero General Public License for more details.
#
#You should have received a copy of the GNU Affero General Public License
#along with Karoshi Server.  If not, see <http://www.gnu.org/licenses/>.

#
#The Karoshi Team can be contacted at: 
#mpsharrad@karoshi.org.uk
#jsharrad@karoshi.org.uk

#
#Website: http://www.karoshi.org.uk
############################
#Language
############################
LANGCHOICE=englishuk
[ -f /opt/karoshi/web_controls/user_prefs/$REMOTE_USER/language_choice ] && source /opt/karoshi/web_controls/user_prefs/$REMOTE_USER/language_choice
[ -f /opt/karoshi/web_controls/language/$LANGCHOICE/client/asset_register ] || LANGCHOICE=englishuk
source /opt/karoshi/web_controls/language/$LANGCHOICE/client/asset_register
[ -f /opt/karoshi/web_controls/language/$LANGCHOICE/all ] || LANGCHOICE=englishuk
source /opt/karoshi/web_controls/language/$LANGCHOICE/all
LOG_DATE=`date +%F`
########################
#Check md5checksum
########################
if ! test -f /opt/karoshi/web_controls/checksums/admin_checksums/asset_register_view_cgi
then
echo `date`: asset_register_view - No Admin MD5Checksum >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi
source /opt/karoshi/web_controls/checksums/admin_checksums/asset_register_view_cgi
MD5SUM=`md5sum /var/www/cgi-bin_karoshi/admin/asset_register_view.cgi | cut -d' ' -f1`
[ $MD5SUM'null' = null ] && MD5SUM=not_set
if [ $MD5SUM'check' != $asset_register_view_cgi'check' ]
then
echo `date`: asset_register_view - Incorrect Admin MD5Checksum >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi

if ! test -f /opt/karoshi/web_controls/checksums/tech_checksums/asset_register_view_cgi
then
echo `date`: asset_register_view - No tech MD5Checksum >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi
source /opt/karoshi/web_controls/checksums/tech_checksums/asset_register_view_cgi
MD5SUM2=`md5sum /var/www/cgi-bin_karoshi/tech/asset_register_view.cgi | cut -d' ' -f1`
[ $MD5SUM2'null' = null ] && MD5SUM2=not_set
if [ $MD5SUM2'check' != $asset_register_view_cgi'check' ]
then
echo `date`: asset_register_view - Incorrect Tech MD5Checksum >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi
########################
#Get variables
########################
numArgs=$#
if [ $numArgs != 0 ]
then
echo `date`: asset_register_view - incorrect number of arguments >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi

read DATA
DATA=`echo $DATA | tr -cd 'A-Za-z0-9\._,:\-+%'`

REMOTE_USER=`echo "$DATA" | cut -s -d: -f1`
REMOTE_ADDR=`echo "$DATA" | cut -s -d: -f2`
REMOTE_MD5=`echo "$DATA" | cut -s -d: -f3`
MOBILE=`echo "$DATA" | cut -s -d: -f4`
LOCATION=`echo "$DATA" | cut -s -d: -f5 | sed 's/+/ /g'`
ACTION=`echo "$DATA" | cut -s -d: -f6`
ASSET=`echo "$DATA" | cut -s -d: -f7`
OPTION=`echo "$DATA" | cut -s -d: -f8`
ASSETCHOICE=`echo "$DATA" | cut -s -d: -f9`

########################
#Check data
########################
if [ $REMOTE_MD5'check' != $MD5SUM'check' ] && [ $REMOTE_MD5'check' != $MD5SUM2'check' ]
then
echo `date`: asset_register_view - Not called by asset_register_view.cgi >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi
if [ $REMOTE_USER'null' = null ]
then
echo `date`: asset_register_view - Blank remote user >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi
if [ $REMOTE_ADDR'null' = null ]
then
echo `date`: asset_register_view - Blank remote tcpip address >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi
if [ `grep -c ^$REMOTE_USER: /opt/karoshi/web_controls/web_access_admin` != 1 ] && [ `grep -c ^$REMOTE_USER: /opt/karoshi/web_controls/web_access_tech` != 1 ]
then
echo `date`: asset_register_view - access denied to $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi


if [ $MOBILE = yes ]
then
TABLECLASS=mobilestandard
ICON1=/images/assets/locationm.png
ICON2=/images/assets/editm.png
ICON3=/images/assets/deletem.png
ICON4=/images/assets/add_assetm.png
ICON5=/images/assets/totalsm.png
ICON6=/images/assets/searchm.png
ICON7=/images/assets/descriptionsm.png
ICON8=/images/assets/addescm.png
ICON9=/images/assets/suppliersm.png
ICON10=/images/assets/adddescm.png
ICON11=/images/assets/addsupplierm.png
ICON12=/images/assets/budgetm.png
ICON13=/images/assets/addbudgetm.png
ICON14=/images/assets/moreinfom.png
ICON15=/images/assets/exportm.png
ICON16=/images/assets/importm.png
ICON17=/images/assets/client_logsm.png
ICON18=/images/assets/qrcodem.png
else
TABLECLASS=standard
ICON1=/images/assets/location.png
ICON2=/images/assets/edit.png
ICON3=/images/assets/delete.png
ICON4=/images/assets/add_asset.png
ICON5=/images/assets/totals.png
ICON6=/images/assets/search.png
ICON7=/images/assets/descriptions.png
ICON8=/images/assets/addesc.png
ICON9=/images/assets/suppliers.png
ICON10=/images/assets/adddesc.png
ICON11=/images/assets/addsupplier.png
ICON12=/images/assets/budget.png
ICON13=/images/assets/addbudget.png
ICON14=/images/assets/moreinfo.png
ICON15=/images/assets/export.png
ICON16=/images/assets/import.png
ICON17=/images/assets/client_logs.png
ICON18=/images/assets/qrcode.png
fi


[ $OPTION'null' = null ] && OPTION=nofilter

[ $ACTION'null' = null ] && ACTION=view
[ $LOCATION'null' = null ] && LOCATION=showchoice

#echo data is $DATA"<br>"
#echo action is $ACTION"<br>"
#echo location is $LOCATION"<br>"
#echo asset is $ASSET"<br>"


if [ $ACTION = qrcodes ]
then
#Load asset_register_show_qrcodes.cgi
echo "</form><form METHOD=POST ACTION=\"/cgi-bin/admin/asset_register_show_qrcodes.cgi\" target=\"_top\" name = \"frm\">
<input type=\"hidden\" name=\"_LOCATION_\" value=\"$LOCATION\">
</form>
<script>
document.frm.submit();
</script><form>
"
fi

function assign_asset_labels {
ASSETLABEL=$ASSETTYPE1
ASSETICON=/images/assets/curriculum_computer.png
if [ $ASSETTYPE = 2 ]
then
ASSETICON=/images/assets/admin_computer.png ; ASSETLABEL=$ASSETTYPE2
fi
if [ $ASSETTYPE = 3 ]
then
ASSETICON=/images/assets/curriculum_laptop.png ; ASSETLABEL=$ASSETTYPE3
fi
if [ $ASSETTYPE = 4 ]
then
ASSETICON=/images/assets/admin_laptop.png ; ASSETLABEL=$ASSETTYPE4
fi
if [ $ASSETTYPE = 5 ]
then
ASSETICON=/images/assets/curriculum_tablet.png ; ASSETLABEL=$ASSETTYPE5
fi
if [ $ASSETTYPE = 6 ]
then
ASSETICON=/images/assets/admin_tablet.png ; ASSETLABEL=$ASSETTYPE6
fi
if [ $ASSETTYPE = 7 ]
then
ASSETICON=/images/assets/curriculum_pda.png ; ASSETLABEL=$ASSETTYPE7
fi
if [ $ASSETTYPE = 8 ]
then
ASSETICON=/images/assets/admin_pda.png ; ASSETLABEL=$ASSETTYPE8
fi
if [ $ASSETTYPE = 9 ]
then
ASSETICON=/images/assets/curriculum_thinclient.png ; ASSETLABEL=$ASSETTYPE9
fi
if [ $ASSETTYPE = 10 ]
then
ASSETICON=/images/assets/admin_thinclient.png ; ASSETLABEL=$ASSETTYPE10
fi
if [ $ASSETTYPE = 11 ]
then
ASSETICON=/images/assets/printer.png ; ASSETLABEL=$ASSETTYPE11
fi
if [ $ASSETTYPE = 12 ]
then
ASSETICON=/images/assets/scanner.png ; ASSETLABEL=$ASSETTYPE12
fi
if [ $ASSETTYPE = 13 ]
then
ASSETICON=/images/assets/projector.png ; ASSETLABEL=$ASSETTYPE13
fi
if [ $ASSETTYPE = 14 ]
then
ASSETICON=/images/assets/whiteboard.png ; ASSETLABEL=$ASSETTYPE14
fi
if [ $ASSETTYPE = 15 ]
then
ASSETICON=/images/assets/network_switch.png ; ASSETLABEL=$ASSETTYPE15
fi
if [ $ASSETTYPE = 16 ]
then
ASSETICON=/images/assets/network_device.png ; ASSETLABEL=$ASSETTYPE16
fi
if [ $ASSETTYPE = 17 ]
then
ASSETICON=/images/assets/wireless.png ; ASSETLABEL=$ASSETTYPE17
fi
if [ $ASSETTYPE = 18 ]
then
ASSETICON=/images/assets/audio_visual.png ; ASSETLABEL=$ASSETTYPE18
fi
if [ $ASSETTYPE = 19 ]
then
ASSETICON=/images/assets/monitor.png ; ASSETLABEL=$ASSETTYPE19
fi
if [ $ASSETTYPE = 20 ]
then
ASSETICON=/images/assets/software.png ; ASSETLABEL=$ASSETTYPE20
fi
if [ $ASSETTYPE = 21 ]
then
ASSETICON=/images/assets/other.png ; ASSETLABEL=$ASSETTYPE21
fi
}

##########################
#Show logs
##########################
if [ $ACTION = showlogs ]
then


#Get asset details
source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
#Redirect to internet logs
TODAY=`date +%d-%m-%Y`

MD5SUM=`md5sum /var/www/cgi-bin_karoshi/admin/dg_view_computer_logs.cgi | cut -d' ' -f1`
#View logs
echo '</form><form action="dg_view_computer_logs.cgi" id="foo" method="post">
<input name="_TCPIP_'$TCPIP1'_DATE_'$TODAY'_DAYCOUNT_1_" value="" type="hidden">
</form>

<script type="text/javascript">
    function myfunc () {
        var frm = document.getElementById("foo");
        frm.submit();
    }
    window.onload = myfunc;
</script>'
ACTION=view
fi
##########################
#Export
##########################
if [ $ACTION = export ]
then
echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_" type="image" class="images" src="'$ICON1'" value=""><span>'$CHOOSELOCATIONMSG'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_add_LOCATION_'$LOCATION'_" type="image" class="images" src="'$ICON4'" value=""><span>'$ADDASSETMSG'</span></a></td>
<td style="vertical-align: top;"><b>'$TITLE16'</b></td><td><a class="info" href="javascript:void(0)"><input name="_ACTION_view_LOCATION_'$LOCATION'_ASSETCHOICE_'$ASSETTYPE'_OPTION_nofilter_" type="image" class="images" src="'$ASSETICON'" value=""><span>'$SHOWALLMSG'</span></a></td></tr></tbody></table><br><br>'

[ $MOBILE != yes ] && echo '</div><div id="infobox">'

echo '<textarea rows="100" cols="150">'
echo $IDENTITYNAME,$LOCATIONMSG,$ASSETTYPEMSG,$DESCRIPTIONMSG,$TCPIPMSG,$MACADDRESSMSG,$SERIAL_KEY,$PURCHASE_DATE,$VALUEMSG,$SUPPLIERMSG,$BUDGETMSG,$USERNAME
for LOCATIONS in /opt/karoshi/asset_register/locations/*
do
LOCATION=`basename $LOCATIONS`
for ASSETS in /opt/karoshi/asset_register/locations/$LOCATION/*
do
ASSET=`basename $ASSETS`
source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
assign_asset_labels
echo $IDENTITY,$LOCATION,$ASSETLABEL,$DESCRIPTION,$TCPIP1 $TCPIP2 $TCPIP3,$MAC1 $MAC2 $MAC3,$SERIAL,$PURCHASEDATE,$VALUE,$SUPPLIER,$BUDGET,$ASSIGNED
done
done
echo '</textarea>'
fi

##########################
#Add description
##########################
if [ $ACTION = adddesc ]
then
echo '<b>'$ADDDESCMSG'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
<tr><td style="width: 180px;">'$DESCRIPTIONMSG'</td><td><input tabindex= "1" name="_OPTION_" style="width: 200px;" size="20" type="text"></td><td>
<a class="info" href="javascript:void(0)"><img class="images" alt="" src="/images/help/info.png"><span>'$DESCHELPMSG1'</span></a></td></tr></tbody></table><br>
<input type="image" src="/images/submenus/file/go.gif" name="_ACTION_reallyadddesc_" value="">
<a href="javascript:history.go(-1)"> <img src="/images/submenus/file/back.gif" alt="back" border="0">
'
fi

if [ $ACTION = reallyadddesc ]
then
echo `date`: asset_register_view - adding description $ASSET by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
#Create folders
[ ! -d /opt/karoshi/asset_register/descriptions ] && mkdir -p /opt/karoshi/asset_register/descriptions
#Get Hardwaredesc number
if [ -f /opt/karoshi/asset_register/.last_desc_number ]
then
DESC_NUMBER=`sed -n 1,1p /opt/karoshi/asset_register/.last_desc_number`
let DESC_NUMBER=$DESC_NUMBER+1
else
DESC_NUMBER=1
fi
echo $DESC_NUMBER > /opt/karoshi/asset_register/.last_desc_number
#Convert spaces
OPTION=`echo $OPTION | sed 's/+/ /g'`
#Add entry
echo "$OPTION" > /opt/karoshi/asset_register/descriptions/$DESC_NUMBER
#Rebuild asset list
[ -f /opt/karoshi/asset_register/description_list ] && rm -f /opt/karoshi/asset_register/description_list
for DESCRIPTIONFILES in /opt/karoshi/asset_register/descriptions/*
do
DESCRIPTIONFILE=`basename $DESCRIPTIONFILES`
DESCRIPTION=`cat /opt/karoshi/asset_register/descriptions/$DESCRIPTIONFILE`
echo '<option value="'$DESCRIPTION'">'$DESCRIPTION'</option>' >> /opt/karoshi/asset_register/description_list
done
#Sort description list
sort /opt/karoshi/asset_register/description_list > /opt/karoshi/asset_register/description_list.$$
rm -f /opt/karoshi/asset_register/description_list
mv /opt/karoshi/asset_register/description_list.$$ /opt/karoshi/asset_register/description_list
ACTION=viewdescriptions
LOCATION=noset
fi

##########################
#Delete descriptions
##########################
if [ $ACTION = deletedescription ]
then
if [ -f /opt/karoshi/asset_register/descriptions/$ASSET ]
then
#Delete description
echo `date`: asset_register_view - deleting description $ASSET by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
rm -f /opt/karoshi/asset_register/descriptions/$ASSET
#Rebuild asset list
if [ `ls -1 /opt/karoshi/asset_register/descriptions/ | wc -l` -gt 0 ]
then
[ -f /opt/karoshi/asset_register/description_list ] && rm -f /opt/karoshi/asset_register/description_list
for DESCRIPTIONFILES in /opt/karoshi/asset_register/descriptions/*
do
DESCRIPTIONFILE=`basename $DESCRIPTIONFILES`
DESCRIPTION=`cat /opt/karoshi/asset_register/descriptions/$DESCRIPTIONFILE`
echo '<option value="'$DESCRIPTION'">'$DESCRIPTION'</option>' >> /opt/karoshi/asset_register/description_list
done
#Sort description list
sort /opt/karoshi/asset_register/description_list > /opt/karoshi/asset_register/description_list.$$
rm -f /opt/karoshi/asset_register/description_list
mv /opt/karoshi/asset_register/description_list.$$ /opt/karoshi/asset_register/description_list
fi
fi
ACTION=viewdescriptions
fi

##########################
#View descriptions
##########################
if [ $ACTION = viewdescriptions ]
then
echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_" type="image" class="images" src="'$ICON1'" value=""><span>'$CHOOSELOCATIONMSG'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_adddesc_LOCATION_notset_" type="image" class="images" src="'$ICON10'" value=""><span>'$ADDDESCMSG'</span></a></td>
<td style="vertical-align: top;"><b>'$TITLE10'</b></td></tr></tbody></table><br>'

if [ `ls -1 /opt/karoshi/asset_register/descriptions/ | wc -l` -gt 0 ]
then
echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
<tr><td style="width: 20px;"></td><td style="vertical-align: top;"><b>'$DESCRIPTIONMSG'</b></td></tr>'

for DESCRIPTIONFILES in /opt/karoshi/asset_register/descriptions/*
do
DESCRIPTIONFILE=`basename $DESCRIPTIONFILES`
DESCRIPTION=`cat /opt/karoshi/asset_register/descriptions/$DESCRIPTIONFILE`
echo '<tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_deletedescription_LOCATION_notset_ASSET_'$DESCRIPTIONFILE'_" type="image" class="images" src="'$ICON3'" value=""><span>'$DELETEDESCMSG'</span></a></td><td>'$DESCRIPTION'</td></tr>'
done
echo '</tbody></table>'
fi
fi

##########################
#Add supplier
##########################
if [ $ACTION = addsupplier ]
then
echo '<b>'$ADDSUPPLIERMSG'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
<tr><td style="width: 180px;">'$SUPPLIERMSG'</td><td><input tabindex= "1" name="_OPTION_" style="width: 200px;" size="20" type="text"></td><td>
<a class="info" href="javascript:void(0)"><img class="images" alt="" src="/images/help/info.png"><span>'$SUPPLIERHELPMSG1'</span></a></td></tr></tbody></table><br>
<input type="image" src="/images/submenus/file/go.gif" name="_ACTION_reallyaddsupplier_" value="">
<a href="javascript:history.go(-1)"> <img src="/images/submenus/file/back.gif" alt="back" border="0">
'
fi

if [ $ACTION = reallyaddsupplier ]
then
echo `date`: asset_register_view - adding supplier $ASSET by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
#Create folders
[ ! -d /opt/karoshi/asset_register/suppliers ] && mkdir -p /opt/karoshi/asset_register/suppliers
#Get Hardwaredesc number
if [ -f /opt/karoshi/asset_register/.last_supplier_number ]
then
SUP_NUMBER=`sed -n 1,1p /opt/karoshi/asset_register/.last_supplier_number`
let SUP_NUMBER=$SUP_NUMBER+1
else
SUP_NUMBER=1
fi
echo $SUP_NUMBER > /opt/karoshi/asset_register/.last_supplier_number
#Convert spaces
OPTION=`echo $OPTION | sed 's/+/ /g'`
#Add entry
echo "$OPTION" > /opt/karoshi/asset_register/suppliers/$SUP_NUMBER
#Rebuild supplier list
[ -f /opt/karoshi/asset_register/supplier_list ] && rm -f /opt/karoshi/asset_register/supplier_list
for SUPPLIERFILES in /opt/karoshi/asset_register/suppliers/*
do
SUPPLIERFILE=`basename $SUPPLIERFILES`
SUPPLIER=`cat /opt/karoshi/asset_register/suppliers/$SUPPLIERFILE`
echo '<option value="'$SUPPLIER'">'$SUPPLIER'</option>' >> /opt/karoshi/asset_register/supplier_list
done

#Sort supplier list
sort /opt/karoshi/asset_register/supplier_list > /opt/karoshi/asset_register/supplier_list.$$
rm -f /opt/karoshi/asset_register/supplier_list
mv /opt/karoshi/asset_register/supplier_list.$$ /opt/karoshi/asset_register/supplier_list

ACTION=viewsuppliers
LOCATION=noset
fi

##########################
#Delete supplier
##########################
if [ $ACTION = deletesupplier ]
then
if [ -f /opt/karoshi/asset_register/suppliers/$ASSET ]
then
#Delete supplier
echo `date`: asset_register_view - deleting supplier $ASSET by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
rm -f /opt/karoshi/asset_register/suppliers/$ASSET
#Rebuild supplier list
if [ `ls -1 /opt/karoshi/asset_register/suppliers/ | wc -l` -gt 0 ]
then
[ -f /opt/karoshi/asset_register/supplier_list ] && rm -f /opt/karoshi/asset_register/supplier_list
for SUPPLIERFILES in /opt/karoshi/asset_register/suppliers/*
do
SUPPLIERFILE=`basename $SUPPLIERFILES`
SUPPLIER=`cat /opt/karoshi/asset_register/suppliers/$SUPPLIERFILE`
echo '<option value="'$SUPPLIER'">'$SUPPLIER'</option>' >> /opt/karoshi/asset_register/supplier_list
done
#Sort supplier list
sort /opt/karoshi/asset_register/supplier_list > /opt/karoshi/asset_register/supplier_list.$$
rm -f /opt/karoshi/asset_register/supplier_list
mv /opt/karoshi/asset_register/supplier_list.$$ /opt/karoshi/asset_register/supplier_list
fi
fi
ACTION=viewsuppliers
fi

##########################
#View Suppliers
##########################
if [ $ACTION = viewsuppliers ]
then
echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_" type="image" class="images" src="'$ICON1'" value=""><span>'$CHOOSELOCATIONMSG'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_addsupplier_LOCATION_notset_" type="image" class="images" src="'$ICON11'" value=""><span>'$ADDSUPPLIERMSG'</span></a></td>
<td style="vertical-align: top;"><b>'$TITLE11'</b></td></tr></tbody></table><br>'

if [ -d /opt/karoshi/asset_register/suppliers/ ]
then
if [ `ls -1 /opt/karoshi/asset_register/suppliers/ | wc -l` -gt 0 ]
then
echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
<tr><td style="width: 20px;"></td><td style="vertical-align: top;"><b>'$SUPPLIERMSG'</b></td></tr>'

for SUPPLIERFILES in /opt/karoshi/asset_register/suppliers/*
do
SUPPLIERFILE=`basename $SUPPLIERFILES`
SUPPLIER=`cat /opt/karoshi/asset_register/suppliers/$SUPPLIERFILE`
echo '<tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_deletesupplier_LOCATION_notset_ASSET_'$SUPPLIERFILE'_" type="image" class="images" src="'$ICON3'" value=""><span>'$DELSUPPLIERMSG'</span></a></td><td>'$SUPPLIER'</td></tr>'
done
echo '</tbody></table>'
fi
fi
fi

##########################
#Add budget
##########################
if [ $ACTION = addbudget ]
then
echo '<b>'$ADDBUDGETMSG'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
<tr><td style="width: 180px;">'$BUDGETMSG'</td><td><input tabindex= "1" name="_OPTION_" style="width: 200px;" size="20" type="text"></td><td>
<a class="info" href="javascript:void(0)"><img class="images" alt="" src="/images/help/info.png"><span>'$BUDGETHELPMSG1'</span></a></td></tr></tbody></table><br>
<input type="image" src="/images/submenus/file/go.gif" name="_ACTION_reallyaddbudget_" value="">
<a href="javascript:history.go(-1)"> <img src="/images/submenus/file/back.gif" alt="back" border="0">
'
fi

if [ $ACTION = reallyaddbudget ]
then
echo `date`: asset_register_view - adding budget $ASSET by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
#Create folders
[ ! -d /opt/karoshi/asset_register/budgets ] && mkdir -p /opt/karoshi/asset_register/budgets
#Get budget number
if [ -f /opt/karoshi/asset_register/.last_budget_number ]
then
BUGET_NUMBER=`sed -n 1,1p /opt/karoshi/asset_register/.last_budget_number`
let BUGET_NUMBER=$BUGET_NUMBER+1
else
BUGET_NUMBER=1
fi
echo $BUGET_NUMBER > /opt/karoshi/asset_register/.last_budget_number
#Convert spaces
OPTION=`echo $OPTION | sed 's/+/ /g'`
#Add entry
echo "$OPTION" > /opt/karoshi/asset_register/budgets/$BUGET_NUMBER
#Rebuild budget list
[ -f /opt/karoshi/asset_register/budget_list ] && rm -f /opt/karoshi/asset_register/budget_list
for BUDGETFILES in /opt/karoshi/asset_register/budgets/*
do
BUDGETFILE=`basename $BUDGETFILES`
BUDGET=`cat /opt/karoshi/asset_register/budgets/$BUDGETFILE`
echo '<option value="'$BUDGET'">'$BUDGET'</option>' >> /opt/karoshi/asset_register/budget_list
done
ACTION=viewbudgets
LOCATION=noset
fi

##########################
#Delete budget
##########################
if [ $ACTION = deletebudget ]
then
if [ -f /opt/karoshi/asset_register/budgets/$ASSET ]
then
#Delete budget
echo `date`: asset_register_view - deleting budget $ASSET by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
rm -f /opt/karoshi/asset_register/budgets/$ASSET
#Rebuild budget list
if [ `ls -1 /opt/karoshi/asset_register/budgets/ | wc -l` -gt 0 ]
then
[ -f /opt/karoshi/asset_register/budget_list ] && rm -f /opt/karoshi/asset_register/budget_list
for BUDGETFILES in /opt/karoshi/asset_register/budgets/*
do
BUDGETFILE=`basename $BUDGETFILES`
BUDGET=`cat /opt/karoshi/asset_register/budgets/$BUDGETFILE`
echo '<option value="'$BUDGET'">'$BUDGET'</option>' >> /opt/karoshi/asset_register/budget_list
done
fi
fi
ACTION=viewbudgets
fi

##########################
#View budgets
##########################
if [ $ACTION = viewbudgets ]
then
echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_" type="image" class="images" src="'$ICON1'" value=""><span>'$CHOOSELOCATIONMSG'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_addbudget_LOCATION_notset_" type="image" class="images" src="'$ICON13'" value=""><span>'$ADDBUDGETMSG'</span></a></td>
<td style="vertical-align: top;"><b>'$TITLE12'</b></td></tr></tbody></table><br>'

if [ -d /opt/karoshi/asset_register/budgets/ ]
then
if [ `ls -1 /opt/karoshi/asset_register/budgets/ | wc -l` -gt 0 ]
then
echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
<tr><td style="width: 20px;"></td><td style="vertical-align: top;"><b>'$BUDGETMSG'</b></td></tr>'

for BUDGETFILES in /opt/karoshi/asset_register/budgets/*
do
BUDGETFILE=`basename $BUDGETFILES`
BUDGET=`cat /opt/karoshi/asset_register/budgets/$BUDGETFILE`
echo '<tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_deletebudget_LOCATION_notset_ASSET_'$BUDGETFILE'_" type="image" class="images" src="'$ICON3'" value=""><span>'$DELBUDGETMSG'</span></a></td><td>'$BUDGET'</td></tr>'
done
echo '</tbody></table>'
fi
fi
fi


if [ $ACTION = showstats ]
then
echo '<b>'$TITLE3'</b><br><br>'

#Stats per room
for LOCATIONS in /opt/karoshi/asset_register/locations/*
do
LOCATION=`basename $LOCATIONS`
TOTAL1=`grep -h -R ASSETTYPE=\"1\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL2=`grep -h -R ASSETTYPE=\"2\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL3=`grep -h -R ASSETTYPE=\"3\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL4=`grep -h -R ASSETTYPE=\"4\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL5=`grep -h -R ASSETTYPE=\"5\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL6=`grep -h -R ASSETTYPE=\"6\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL7=`grep -h -R ASSETTYPE=\"7\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL8=`grep -h -R ASSETTYPE=\"8\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL9=`grep -h -R ASSETTYPE=\"9\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL10=`grep -h -R ASSETTYPE=\"10\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL11=`grep -h -R ASSETTYPE=\"11\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL12=`grep -h -R ASSETTYPE=\"12\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL13=`grep -h -R ASSETTYPE=\"13\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL14=`grep -h -R ASSETTYPE=\"14\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL15=`grep -h -R ASSETTYPE=\"15\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL16=`grep -h -R ASSETTYPE=\"16\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL17=`grep -h -R ASSETTYPE=\"17\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL18=`grep -h -R ASSETTYPE=\"18\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL19=`grep -h -R ASSETTYPE=\"19\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL20=`grep -h -R ASSETTYPE=\"20\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
TOTAL21=`grep -h -R ASSETTYPE=\"21\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`


echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_LOCATION_'$LOCATION'_" type="image" class="images" src="'$ICON1'" value=""><span>'$TITLE2'<br>'$LOCATION'</span></a></td><td><b>'$TOTALS - $LOCATION'</b></td></tr></tbody></table><br>'

echo '<table class="'$TABLECLASS'" style="text-align: left; width: 100%;"><tbody>'
echo "<tr><td>$CURRICCOMPUTER</td><td>$TOTAL1</td><td>$ADMINCOMPUTER</td><td>$TOTAL2</td><td>$CURRICULUMLAPTOP</td><td>$TOTAL3</td><td>$ADMINLAPTOP</td><td>$TOTAL4</td></tr>"
echo "<tr><td>$CURRICULUMTABLET</td><td>$TOTAL5</td><td>$ADMINTABLET</td><td>$TOTAL6</td><td>$CURRICULUMPDA</td><td>$TOTAL7</td><td>$ADMINPDA</td><td>$TOTAL8</td></tr>"
echo "<tr><td>$CURRICTHINCLIENT</td><td>$TOTAL9</td><td>$ADMINTHINCLIENT</td><td>$TOTAL10</td><td>$PRINTER</td><td>$TOTAL11</td><td>$SCANNER</td><td>$TOTAL12</td></tr>"
echo "<tr><td>$PROJECTOR</td><td>$TOTAL13</td><td>$WHITEBOARD</td><td>$TOTAL14</td><td>$NETWORKSWITCH</td><td>$TOTAL15</td><td>$NETWORKDEVICE</td><td>$TOTAL16</td></tr>"
echo "<tr><td>$WIRELESSACCESSPT</td><td>$TOTAL17</td><td>$AUDIOVISUAL</td><td>$TOTAL18</td><td>$MONITOR</td><td>$TOTAL19</td><td>$SOFTWARE</td><td>$TOTAL20</td></tr>"
echo "<tr><td>$OTHER</td><td>$TOTAL21</td></tr>"
echo "</tbody></table><br>"
done

#Total stats
TOTAL1=`grep -h -R ASSETTYPE=\"1\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL2=`grep -h -R ASSETTYPE=\"2\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL3=`grep -h -R ASSETTYPE=\"3\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL4=`grep -h -R ASSETTYPE=\"4\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL5=`grep -h -R ASSETTYPE=\"5\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL6=`grep -h -R ASSETTYPE=\"6\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL7=`grep -h -R ASSETTYPE=\"7\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL8=`grep -h -R ASSETTYPE=\"8\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL9=`grep -h -R ASSETTYPE=\"9\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL10=`grep -h -R ASSETTYPE=\"10\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL11=`grep -h -R ASSETTYPE=\"11\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL12=`grep -h -R ASSETTYPE=\"12\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL13=`grep -h -R ASSETTYPE=\"13\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL14=`grep -h -R ASSETTYPE=\"14\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL15=`grep -h -R ASSETTYPE=\"15\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL16=`grep -h -R ASSETTYPE=\"16\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL17=`grep -h -R ASSETTYPE=\"17\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL18=`grep -h -R ASSETTYPE=\"18\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL19=`grep -h -R ASSETTYPE=\"19\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL20=`grep -h -R ASSETTYPE=\"20\" /opt/karoshi/asset_register/locations/* | wc -l`
TOTAL21=`grep -h -R ASSETTYPE=\"21\" /opt/karoshi/asset_register/locations/* | wc -l`
echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_" type="image" class="images" src="'$ICON1'" value=""><span>'$TITLE2'</span></a></td><td><b>'$TOTALS'</b></td></tr></tbody></table><br>'
echo '<table class="'$TABLECLASS'" style="text-align: left; width: 100%;"><tbody>'
echo "<tr><td>$CURRICCOMPUTER</td><td>$TOTAL1</td><td>$ADMINCOMPUTER</td><td>$TOTAL2</td><td>$CURRICULUMLAPTOP</td><td>$TOTAL3</td><td>$ADMINLAPTOP</td><td>$TOTAL4</td></tr>"
echo "<tr><td>$CURRICULUMTABLET</td><td>$TOTAL5</td><td>$ADMINTABLET</td><td>$TOTAL6</td><td>$CURRICULUMPDA</td><td>$TOTAL7</td><td>$ADMINPDA</td><td>$TOTAL8</td></tr>"
echo "<tr><td>$CURRICTHINCLIENT</td><td>$TOTAL9</td><td>$ADMINTHINCLIENT</td><td>$TOTAL10</td><td>$PRINTER</td><td>$TOTAL11</td><td>$SCANNER</td><td>$TOTAL12</td></tr>"
echo "<tr><td>$PROJECTOR</td><td>$TOTAL13</td><td>$WHITEBOARD</td><td>$TOTAL14</td><td>$NETWORKSWITCH</td><td>$TOTAL15</td><td>$NETWORKDEVICE</td><td>$TOTAL16</td></tr>"
echo "<tr><td>$WIRELESSACCESSPT</td><td>$TOTAL17</td><td>$AUDIOVISUAL</td><td>$TOTAL18</td><td>$MONITOR</td><td>$TOTAL19</td><td>$SOFTWARE</td><td>$TOTAL20</td></tr>"
echo "<tr><td>$OTHER</td><td>$TOTAL21</td></tr>"
echo "</tbody></table><br>"
fi

############################
#Show choice of locations
############################
if [ $LOCATION = showchoice ]
then
ROWCOUNT=6
[ $MOBILE = yes ] && ROWCOUNT=3
WIDTH=90
[ $MOBILE = yes ] && WIDTH=70

echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr><td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$TITLE3'</b></td><td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$SEARCHMSG'</b></td>
<td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$TITLE15'</b></td>
<td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$TITLE14'</b></td></tr>
<tr><td style="vertical-align: top; height: 30px;"><a class="info" href="javascript:void(0)"><input name="_ACTION_showstats_LOCATION_notset_" type="image" class="images" src="'$ICON5'" value=""><span>'$TITLE3'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_search_LOCATION_notset_" type="image" class="images" src="'$ICON6'" value=""><span>'$SEARCHMSG'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_import_LOCATION_notset_" type="image" class="images" src="'$ICON16'" value=""><span>'$TITLE15'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_export_LOCATION_notset_" type="image" class="images" src="'$ICON15'" value=""><span>'$TITLE14'</span></a></td>
</tr><tr>
<td style="vertical-align: top; height: 30px;"><b>'$ADDASSETMSG'</b></td><td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$DESCRIPTIONMSG2'</b></td><td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$SUPPLIERMSG2'</b></td><td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$BUDGETMSG2'</b></td>
</tr><tr>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_add_LOCATION_notset_" type="image" class="images" src="'$ICON4'" value=""><span>'$ADDASSETMSG'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_viewdescriptions_LOCATION_notset_" type="image" class="images" src="'$ICON7'" value=""><span>'$DESCRIPTIONMSG'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_viewsuppliers_LOCATION_notset_" type="image" class="images" src="'$ICON9'" value=""><span>'$SUPPLIERMSG2'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_viewbudgets_LOCATION_notset_" type="image" class="images" src="'$ICON12'" value=""><span>'$BUDGETMSG2'</span></a></td>
</tr></tbody></table><br>'
if [ `ls -1 /opt/karoshi/asset_register/locations/ | wc -l`  -gt 0 ]
then
echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr><td style="vertical-align: top;"><b>'$TITLE2' - Choose Location</b></td></tr></tbody></table><br>'

[ $MOBILE != yes ] && echo '</div><div id="infobox">'

echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr>'
LOCCOUNTER=1
LOCATIONARRAY=( `ls /opt/karoshi/asset_register/locations/ | sort -f` )
ARRAYCOUNT=0
ARRAYMAX=${#LOCATIONARRAY[@]}
while [ $ARRAYCOUNT -lt $ARRAYMAX ]
do
LOCATION=${LOCATIONARRAY[$ARRAYCOUNT]}
echo '<td style="width: '$WIDTH'px; vertical-align: top; text-align: left;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_LOCATION_'$LOCATION'_" type="image" class="images" src="'$ICON1'" value=""><span>'$TITLE2'<br>'$LOCATION'</span></a><br>'$LOCATION'</td>'
[ $LOCCOUNTER = $ROWCOUNT ] && echo '</tr><tr>'
let LOCCOUNTER=$LOCCOUNTER+1
[ $LOCCOUNTER -gt $ROWCOUNT ] && LOCCOUNTER=1
let ARRAYCOUNT=$ARRAYCOUNT+1
done
echo "</tr></tbody></table><br>"
LOCATION=showchoice
fi
fi

##########################
#Delete assets
##########################
if [ $ACTION = delete ]
then
if [ $ASSET'null' != null ]
then
if [ -f /opt/karoshi/asset_register/locations/$LOCATION/$ASSET ]
then
source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
echo '<b>'$TITLE8'</b><br><br>'
echo $DELETEMSG $IDENTITY'<br><br>'$CONFIRMDELETEMSG'<br><br>'
echo '<input type="image" src="/images/submenus/file/delete.gif" name="_ACTION_reallydelete_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" value="">'
echo '<a href="javascript:history.go(-1)"> <img src="/images/submenus/file/back.gif" alt="back" border="0"></a>'
else
echo No data "file" exists "for" this asset.
fi
else
echo no asset set.
fi
fi

if [ $ACTION = reallydelete ]
then
ACTION=view
if [ $ASSET'null' != null ]
then
if [ -f /opt/karoshi/asset_register/locations/$LOCATION/$ASSET ]
then
[ ! -d /opt/karoshi/asset_register/deleted/$LOCATION/ ] && mkdir -p /opt/karoshi/asset_register/deleted/$LOCATION/
source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
#Delete entry from netlogon
[ -f /var/lib/samba/netlogon/clients/$MAC1 ] && rm -f /var/lib/samba/netlogon/clients/$MAC1
#Move entry to deleted folder
mv -f /opt/karoshi/asset_register/locations/$LOCATION/$ASSET /opt/karoshi/asset_register/deleted/$LOCATION/
echo `date`: asset_register_view - deleting $ASSET from $LOCATION by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
fi
fi
fi


function asset_form {
echo '<input type="image" src="/images/submenus/file/go.gif" name="_ACTION_really'$ACTION'_ASSET_'$ASSET'_" value="">'
echo '<a href="javascript:history.go(-1)"> <img src="/images/submenus/file/back.gif" alt="back" border="0"></a><br><br>'
echo '<table style="text-align: left;" border="0" cellpadding="2" cellspacing="2" class="'$TABLECLASS'"><tbody>'
if [ $ACTION = edit ]
then
echo '<tr><td style="width: 180px;">'$ASSETNUMMSG'</td><td>'$ASSET'</td></tr>'
else
echo '<tr><td></td></tr>'
fi
echo '<tr><td style="width: 180px;">'$ASSETTYPEMSG'</td><td>'
echo '<select name="_ASSETTYPE_" style="width: 200px;" tabindex= "1">'
[ $ACTION = edit ] && echo '<option value="'$ASSETTYPE'" selected="selected">Current</option>'
echo '<option value="1">'$CURRICCOMPUTER'</option>'
echo '<option value="2">'$ADMINCOMPUTER'</option>'
echo '<option value="3">'$CURRICULUMLAPTOP'</option>'
echo '<option value="4">'$ADMINLAPTOP'</option>'
echo '<option value="5">'$CURRICULUMTABLET'</option>'
echo '<option value="6">'$ADMINTABLET'</option>'
echo '<option value="7">'$CURRICULUMPDA'</option>'
echo '<option value="8">'$ADMINPDA'</option>'
echo '<option value="9">'$CURRICTHINCLIENT'</option>'
echo '<option value="10">'$ADMINTHINCLIENT'</option>'
echo '<option value="11">'$PRINTER'</option>'
echo '<option value="12">'$SCANNER'</option>'
echo '<option value="13">'$PROJECTOR'</option>'
echo '<option value="14">'$WHITEBOARD'</option>'
echo '<option value="15">'$NETWORKSWITCH'</option>'
echo '<option value="16">'$NETWORKDEVICE'</option>'
echo '<option value="17">'$WIRELESSACCESSPT'</option>'
echo '<option value="18">'$AUDIOVISUAL'</option>'
echo '<option value="19">'$MONITOR'</option>'
echo '<option value="20">'$SOFTWARE'</option>'
echo '<option value="21">'$OTHER'</option>'
echo '<option value=""></option>'
echo '</select></td>'
#Value
echo '<td style="width: 180px;">'$VALUEMSG'</td><td><input size="17" name="_VALUE_" value="'$VALUE'" style="width: 200px;" tabindex= "9" ></td></tr>'
#Location
echo '<tr><td>'$LOCATIONMSG'<td><select name="_LOCATION_" style="width: 200px;" tabindex= "2">
<option value="'$LOCATION'">'$LOCATION'</option>'
COUNTER=1
if [ -f /var/lib/samba/netlogon/locations.txt ]
then
LOCATION_COUNT=`cat /var/lib/samba/netlogon/locations.txt | wc -l`
else
LOCATION_COUNT=0
fi
while [ $COUNTER -lt $LOCATION_COUNT ]
do
LOCATION=`sed -n $COUNTER,$COUNTER'p' /var/lib/samba/netlogon/locations.txt`
echo '<option value="'$LOCATION'">'$LOCATION'</option>'
let COUNTER=$COUNTER+1
done
echo '</select></td>'
#Serial Code
DATE=`date +%d-%m-%y`
echo '<td>'$SERIALKEY'</td><td><input size="23" style="width: 200px;" value="'$SERIAL'" name="_SERIALKEY_" tabindex= "10"></td></tr>'
if [ $ACTION = edit ]
then
#Identity
echo '<tr><td>'$IDENTITYNAME'</td><td>
<input size="23" style="width: 200px;" value="'$IDENTITY'" name="_IDENTITY_" tabindex= "3">
</td>'
else
#os type
echo '<tr><td>'$OSTYPE'</td><td>
<select name="_IDENTITY_" style="width: 200px;" tabindex= "3">
	<option value=""></option>
        <option value="lx">Linux</option>
        <option value="mc">Mac</option>
        <option value="wn">Windows</option>
        <option value="or">Other</option>
	</select>
</td>'
fi
#Assigned to
echo '<td>'$USERNAME'</td><td><input size="17" name="_USERNAME_" value="'$ASSIGNED'" style="width: 200px;" tabindex= "11"></td></tr>'
#Budget
echo '<tr><td><a href="/cgi-bin/admin/asset_register_add_budget_fm.cgi">'$BUDGETMSG'</a></td><td><select name="_BUDGET_" style="width: 200px;" tabindex= "4">'
echo '<option value="'$BUDGET'">'$BUDGET'</option>'
[ -f /opt/karoshi/asset_register/supplier_list ] && cat /opt/karoshi/asset_register/budget_list
echo '<option value=""></option>'
echo '</select></td>'
#Asset Purchase date

[ $ACTION = add ] && PURCHASEDATE=`date +%d-%m-%y`

echo '<td>'$PURCHASE_DATE'</td><td><input maxlength="15" size="17" name="_PURCHASEDATE_" value="'$PURCHASEDATE'" style="width: 200px;" tabindex= "12"></td></tr>'
#Description
echo '<tr><td><a href="/cgi-bin/admin/asset_register_add_description_fm.cgi">'$DESCRIPTIONMSG'</a></td><td><select name="_DESCRIPTION_" style="width: 200px;" tabindex= "5">'
echo '<option value="'$DESCRIPTION'">'$DESCRIPTION'</option>'
[ -f /opt/karoshi/asset_register/description_list ] && cat /opt/karoshi/asset_register/description_list
echo '<option value=""></option>'
echo '</select></td>'
#Supplier
echo '<td><a href="/cgi-bin/admin/asset_register_add_supplier_fm.cgi">'$SUPPLIERMSG'</a></td><td><select name="_SUPPLIER_" style="width: 200px;" tabindex= "13">'
echo '<option value="'$SUPPLIER'">'$SUPPLIER'</option>'
[ -f /opt/karoshi/asset_register/supplier_list ] && cat /opt/karoshi/asset_register/supplier_list
echo '<option value=""></option></select></td></tr>'
#TCPIP1
echo '<tr><td>'$TCPIP' 1</td><td><input maxlength="15" size="17" name="_TCPIP1_" value="'$TCPIP1'" style="width: 200px;" tabindex= "6"></td>'
#MAC Address1
echo '<td>'$MACADDRESS' 1</td><td><input maxlength="17" size="17" name="_MACADDRESS1_" value="'$MAC1'" style="width: 200px;" tabindex= "14"></td></tr>'
#TCPIP2
echo '<tr><td>'$TCPIP' 2</td><td><input maxlength="15" size="17" name="_TCPIP2_" value="'$TCPIP2'" style="width: 200px;" tabindex= "7"></td>'
#MAC address2
echo '<td>'$MACADDRESS' 2</td><td><input maxlength="17" size="17" name="_MACADDRESS2_" value="'$MAC2'" style="width: 200px;" tabindex= "15"></td></tr>'
#TCPIP3
echo '<tr><td>'$TCPIP' 3</td><td><input maxlength="15" size="17" name="_TCPIP3_" value="'$TCPIP3'" style="width: 200px;" tabindex= "8"></td>'
#MAC address3
echo '<td>'$MACADDRESS' 3</td><td><input maxlength="17" size="17" name="_MACADDRESS3_" value="'$MAC3'" style="width: 200px;" tabindex= "16"></td></tr>'
#Extra information
echo '<tr><td style="vertical-align: top;">'$EXTRAINFOMSG'</td><td colspan="3" rowspan="1" style="vertical-align: top;"><textarea style="width: 200px;" tabindex= "17" cols="100" rows="1" name="_EXTRAINFO_">'$EXTRAINFO'</textarea>
</td></tr>'
echo '</tbody></table><br>'

}

##########################
#Edit assets
##########################
if [ $ACTION = edit ]
then
if [ $ASSET'null' != null ]
then
if [ -f /opt/karoshi/asset_register/locations/$LOCATION/$ASSET ]
then
source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
echo '<b>'$TITLE9' - '$IDENTITY'</b><br><br>'
asset_form
else
echo No data "file" exists "for" this asset.
fi
else
echo no asset set.
fi
fi


function get_asset_data {
ASSETTYPE=`echo "$DATA" | cut -s -d: -f10 | tr cd '0-9'`
[ $ASSETTYPE'null' = null ] && ASSETTYPE=21
TCPIP1=`echo "$DATA" | cut -s -d: -f11`
TCPIP2=`echo "$DATA" | cut -s -d: -f12`
TCPIP3=`echo "$DATA" | cut -s -d: -f13`
MACADDRESS1=`echo "$DATA" | cut -s -d: -f14 | sed 's/%3A/:/g' | sed 's/-/:/g'`
MACADDRESS2=`echo "$DATA" | cut -s -d: -f15 | sed 's/%3A/:/g' | sed 's/-/:/g'`
MACADDRESS3=`echo "$DATA" | cut -s -d: -f16 | sed 's/%3A/:/g' | sed 's/-/:/g'`
SERIALKEY=`echo "$DATA" | cut -s -d: -f17`
PURCHASEDATE=`echo "$DATA" | cut -s -d: -f18`
IDENTITY=`echo "$DATA" | cut -s -d: -f19 | sed 's/+/ /g' | sed 's/%3A/:/g'`
DESCRIPTION=`echo "$DATA" | cut -s -d: -f20 | sed 's/+/ /g' | sed 's/%3A/:/g'`
USERNAME=`echo "$DATA" | cut -s -d: -f21 | sed 's/+/ /g'`
VALUE=`echo "$DATA" | cut -s -d: -f22 | sed 's/+/ /g' | sed 's/%A3/\&\#163;/g' | sed 's/%C2&#163;/£/g'`
SUPPLIER=`echo "$DATA" | cut -s -d: -f23 | sed 's/+/ /g' | sed 's/%3A/:/g'`
BUDGET=`echo "$DATA" | cut -s -d: -f24 | sed 's/+/ /g' | sed 's/%3A/:/g'`
EXTRAINFO=`echo "$DATA" | cut -s -d: -f26 | sed 's/+/ /g' | sed 's/%3A/:/g' | sed 's/%0D%0A/ /g'`
}

function write_asset_data {
[ ! -d "/opt/karoshi/asset_register/locations/$LOCATION/" ] && mkdir -p "/opt/karoshi/asset_register/locations/$LOCATION/"

[ $ACTION = reallyadd ] && IDENTITY=$IDENTITY$ASSET

echo ASSETTYPE=\""$ASSETTYPE"\" > "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo DESCRIPTION=\""$DESCRIPTION"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo IDENTITY=\""$IDENTITY"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo ASSIGNED=\""$USERNAME"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo TCPIP1=\""$TCPIP1"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo TCPIP2=\""$TCPIP2"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo TCPIP3=\""$TCPIP3"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo MAC1=\""$MACADDRESS1"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo MAC2=\""$MACADDRESS2"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo MAC3=\""$MACADDRESS3"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo SERIAL=\""$SERIALKEY"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo PURCHASEDATE=\""$PURCHASEDATE"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo VALUE=\""$VALUE"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo SUPPLIER=\""$SUPPLIER"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo BUDGET=\""$BUDGET"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo EXTRAINFO=\""$EXTRAINFO"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"

#Add details to netlogon
if [ $MACADDRESS1'null' != null ]
then
if [ $MACADDRESS1 != N.A. ]
then
if [ ! -d /var/lib/samba/netlogon/clients ]
then
mkdir /var/lib/samba/netlogon/clients
fi
CLIENTMAC=`echo $MACADDRESS1 | sed 's/://g'`
echo $IDENTITY > /var/lib/samba/netlogon/clients/"$CLIENTMAC"
echo $TCPIP1 >> /var/lib/samba/netlogon/clients/"$CLIENTMAC"
echo $LOCATION >> /var/lib/samba/netlogon/clients/"$CLIENTMAC"
fi
fi

if [ $MACADDRESS2'null' != null ]
then
if [ $MACADDRESS2 != N.A. ]
then
CLIENTMAC=`echo $MACADDRESS2 | sed 's/://g'`
echo $IDENTITY > /var/lib/samba/netlogon/clients/"$CLIENTMAC"
echo $TCPIP2 >> /var/lib/samba/netlogon/clients/"$CLIENTMAC"
echo $LOCATION >> /var/lib/samba/netlogon/clients/"$CLIENTMAC"
fi
fi


if [ $MACADDRESS3'null' != null ]
then
if [ $MACADDRESS3 != N.A. ]
then
CLIENTMAC=`echo $MACADDRESS3 | sed 's/://g'`
echo $IDENTITY > /var/lib/samba/netlogon/clients/"$CLIENTMAC"
echo $TCPIP3 >> /var/lib/samba/netlogon/clients/"$CLIENTMAC"
echo $LOCATION >> /var/lib/samba/netlogon/clients/"$CLIENTMAC"
fi
fi

if [[ $TCPIP1 ]] && [[ $TCPIP1 != "N.A." ]]; then
	LDAPPASS=`sed -n 1,1p /etc/ldap.secret`
	source /opt/karoshi/server_network/domain_information/domain_name
	
	#Add entry to dns for TCPIP1
	echo `date`: asset_register_view - checking "if" $IDENTITY is "in" the dns records by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	samba-tool dns query 127.0.0.1 $REALM $IDENTITY A --username=Administrator --password=$LDAPPASS 1>> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE 2>> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	if [ `echo $?` != 0 ]
	then
		echo `date`: asset_register_view - removing existing $IDENTITY $TCPIP1 from dns records by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		samba-tool dns delete 127.0.0.1 $REALM $IDENTITY A $TCPIP1 --username=Administrator --password=$LDAPPASS 1>> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE 2>> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	fi
	echo `date`: asset_register_view - adding $IDENTITY $TCPIP1 to the dns records by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	samba-tool dns add 127.0.0.1 $REALM $IDENTITY A $TCPIP1 --username=Administrator --password=$LDAPPASS 1>> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE 2>> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	
	#Add reverse DNS entry for TCPIP1
	SUBNET=$(grep "netmask " /etc/network/interfaces | sed -n 1,1p | cut -d" " -f2)
	echo `date`: asset_register_view - adding a reverse DNS entry "for" $IDENTITY $TCPIP1 by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	/opt/karoshi/serversetup/pdc/"useful scripts"/reverse-dns add $TCPIP1 $SUBNET $IDENTITY.$REALM
fi
}

#Check for duplicate tcpip and mac addresses
function check_duplicate_data {
if [ $SEARCHITEM'null' != null ]
then
if [ `grep -R -h -w $SEARCHITEM /opt/karoshi/asset_register/locations/* | wc -l` -gt 0 ]
then
#Show error message and back button.
echo ''$SEARCHITEM' - '$ERRORMSG17'<br><br><a href="javascript:history.go(-1)"> <img src="/images/submenus/file/back.gif" alt="back" border="0"></a><br><br>'

exit
fi
fi
}


function get_asset_number {
#Check that asset register is not locked
if [ -f /opt/karoshi/asset_register/.asset_lock ]
then
echo $ERRORMSG16
exit 104
else
#Create lock file
touch /opt/karoshi/asset_register/.asset_lock
fi
#Get asset number
if [ -f /opt/karoshi/asset_register/.last_asset_number ]
then
ASSET=`sed -n 1,1p /opt/karoshi/asset_register/.last_asset_number`
let ASSET=$ASSET+1
else
ASSET=1
fi
echo $ASSET > /opt/karoshi/asset_register/.last_asset_number
}


if [ $ACTION = reallyadd ]
then
#Add asset
get_asset_data

#Check that tcpip and mac addresses are not already in use.
if [ $TCPIP1'null' != null ]
then
SEARCHITEM=$TCPIP1
check_duplicate_data
fi
if [ $TCPIP2'null' != null ]
then
SEARCHITEM=$TCPIP2
check_duplicate_data
fi
if [ $TCPIP3'null' != null ]
then
SEARCHITEM=$TCPIP3
check_duplicate_data
fi
if [ $MAC1'null' != null ]
then
SEARCHITEM=$MAC1
check_duplicate_data
fi
if [ $MAC2'null' != null ]
then
SEARCHITEM=$MAC2
check_duplicate_data
fi
if [ $MAC3'null' != null ]
then
SEARCHITEM=$MAC3
check_duplicate_data
fi

get_asset_number

echo `date`: asset_register_view - adding $IDENTITY to $LOCATION by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
write_asset_data
#Delete lock file
rm -f /opt/karoshi/asset_register/.asset_lock
ACTION=view
fi

if [ $ACTION = reallyedit ]
then
ACTION=view
if [ $ASSET'null' != null ]
then
#Edit asset
get_asset_data

echo `date`: asset_register_view - editing $IDENTITY from $LOCATION by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
#Delete asset 

CURRENT_ASSETPATH=`find /opt/karoshi/asset_register/locations -name $ASSET`

[ -f $CURRENT_ASSETPATH ] && rm -f $CURRENT_ASSETPATH 

#Check that tcpip and mac addresses are not already in use.
if [ $TCPIP1'null' != null ]
then
SEARCHITEM=$TCPIP1
check_duplicate_data
fi
if [ $TCPIP2'null' != null ]
then
SEARCHITEM=$TCPIP2
check_duplicate_data
fi
if [ $TCPIP3'null' != null ]
then
SEARCHITEM=$TCPIP3
check_duplicate_data
fi
if [ $MAC1'null' != null ]
then
SEARCHITEM=$MAC1
check_duplicate_data
fi
if [ $MAC2'null' != null ]
then
SEARCHITEM=$MAC2
check_duplicate_data
fi
if [ $MAC3'null' != null ]
then
SEARCHITEM=$MAC3
check_duplicate_data
fi

#Write asset 
write_asset_data

fi
fi

if [ $ACTION = add ]
then
echo '<b>'$TITLE1'</b><br><br>'
asset_form
fi

############################
#Show assets in a location 
############################
if [ $ACTION = view ] && [ $LOCATION != showchoice ]
then

if [ $OPTION = filter ]
then
ASSETTYPE=$ASSETCHOICE
assign_asset_labels
echo '<b>'$TITLE13' - '$LOCATION'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr>
<td style="vertical-align: top;"><input name="_ACTION_view_LOCATION_'$LOCATION'_ASSETCHOICE_'$ASSETTYPE'_OPTION_nofilter_" type="submit" class="button" value="'$SHOWALLMSG'"></td>
<td style="vertical-align: top;"><input name="_ACTION_view_" type="submit" class="button" value="'$CHOOSELOCATIONMSG'"></td>'

[ $MOBILE = yes ] && echo '</tr><tr>'

echo '<td style="vertical-align: top;"><input name="_ACTION_add_LOCATION_'$LOCATION'_" type="submit" class="button" value="'$ADDASSETMSG'"></td>'
if [ -f /opt/karoshi/server_network/distribution_server ]
then 
echo '<td style="vertical-align: top;"></form><form action="client_boot_controls.cgi" id="foo" method="post"><input name="_LOCATION_'$LOCATION'_" type="submit" class="button" value="'$TITLE6'"></form><form action="asset_register_view.cgi" id="foo" method="post"></td>'
fi
echo '</tr></tbody></table>
'
else
echo '<b>'$TITLE13' - '$LOCATION'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr>
<td style="vertical-align: top;"><input name="_ACTION_view_" type="submit" class="button" value="'$CHOOSELOCATIONMSG'"></td>
<td style="vertical-align: top;"><input name="_ACTION_add_LOCATION_'$LOCATION'_" type="submit" class="button" value="'$ADDASSETMSG'"></td>'

[ $MOBILE = yes ] && echo '</tr><tr>'

echo '<td style="vertical-align: top;"><input name="_ACTION_qrcodes_LOCATION_'$LOCATION'_" type="submit" class="button" value="'$TITLE19'"></td>'
if [ -f /opt/karoshi/server_network/distribution_server ]
then 
echo '<td style="vertical-align: top;"></form><form action="client_boot_controls.cgi" id="foo" method="post"><input name="_LOCATION_'$LOCATION'_" type="submit" class="button" value="'$TITLE6'"></form><form action="asset_register_view.cgi" id="foo" method="post"></td>'
fi
echo '</tr></tbody></table>
'
fi

[ $MOBILE != yes ] && echo '</div><div id="infobox">'

if [ `ls -1 /opt/karoshi/asset_register/locations/$LOCATION/ | wc -l` -gt 0 ]
then
echo '
<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
<tr><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 20px;"></td>'

if [ $MOBILE = no ]
then
echo '<td style="width: 60px;">'$IDENTITYNAME'</td><td style="width: 240px;">'$DESCRIPTIONMSG'</td><td style="width: 100px;">'$TCPIPMSG'</td><td style="width: 110px;">'$MACADDRESSMSG'</td><td style="width: 30px;">'$SERIAL_KEY'</td></tr>'
else
echo '</tr>'
fi
for ASSETS in /opt/karoshi/asset_register/locations/$LOCATION/*
do
ASSET=`basename $ASSETS`
#Get asset information
source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
assign_asset_labels
SHOWENTRY=yes
if [ $OPTION = filter ]
then
SHOWENTRY=no
[ $ASSETTYPE = $ASSETCHOICE ] && SHOWENTRY=yes
fi
if [ $SHOWENTRY = yes ]
then
echo '<tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><img class="images" alt="" src="/images/help/info.png"><span>'$ASSIGNEDMSG' : '$ASSIGNED'<br>'$PURCHASE_DATE' : '$PURCHASEDATE'<br>'$VALUEMSG' : '$VALUE'<br>'$SUPPLIERMSG' : '$SUPPLIER'<br>'$BUDGETMSG' : '$BUDGET'<br>'$TCPIPMSG'<br>'$TCPIP1' '$TCPIP2' '$TCPIP3'<br>'$MACADDRESSMSG'<br>'$MAC1' '$MAC2' '$MAC3'</span></a></td><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_edit_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" type="image" class="images" src="'$ICON2'" value=""><span>'$EDITMSG' '$IDENTITY'</span></a></td><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_delete_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" type="image" class="images" src="'$ICON3'" value=""><span>'$DELETEMSG' '$IDENTITY'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_LOCATION_'$LOCATION'_ASSETCHOICE_'$ASSETTYPE'_OPTION_filter_" type="image" class="images" src="'$ASSETICON'" value=""><span>'$ASSETLABEL'</span></a></td>
<td style="vertical-align: top;">'
if [ $ASSETTYPE -le 8 ]
then
echo '<a class="info" href="javascript:void(0)"><input name="_ACTION_showlogs_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" type="image" class="images" src="'$ICON17'" value=""><span>Show logs '$IDENTITY'</span></a></td>'
fi
echo '<td style="vertical-align: top;">'$IDENTITY'</td>'
if [ $MOBILE = no ]
then
echo '<td style="vertical-align: top;">'$DESCRIPTION'</td><td style="vertical-align: top;">'$TCPIP1' '$TCPIP2' '$TCPIP3'</td><td style="vertical-align: top;">'$MAC1' '$MAC2' '$MAC3'</td><td style="vertical-align: top;">'$SERIAL'</td></tr>'
else
echo '</tr>'
fi
fi
done
echo '</tbody></table>'
else
echo $ERRORMSG15
fi
fi

########################
#Search
########################
if [ $ACTION = search ]
then
echo '<b>'$TITLE5'</b><br><br>
<input type="image" src="/images/submenus/file/go.gif" name="_ACTION_reallysearch_LOCATION_notset_" value="">
<a href="javascript:history.go(-1)"> <img src="/images/submenus/file/back.gif" alt="back" border="0"></a><br>
<table class="'$TABLECLASS'" style="text-align: left; height: 30px;" border="0" cellpadding="2" cellspacing="2"><tbody>
<tr><td style="width: 200px;">'$SEARCHMSG'</td><td><input name="_OPTION_" size="20" type="text"></td><td><a class="info" href="javascript:void(0)"><img class="images" alt="" src="/images/help/info.png"><span>'$SEARCHHELP'</span></a></td></tr></tbody></table><br>'
fi

if [ $ACTION = reallysearch ]
then
#Convert colons.
OPTION=`echo $OPTION | sed 's/%3A/:/g'`

echo '<b>'$TITLE5' - '$OPTION'</b><br><br>'

[ $MOBILE != yes ] && echo '</div><div id="infobox">'

echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
<tr><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 60px;">'$IDENTITYNAME'</td>'
if [ $MOBILE = no ]
then
echo '<td style="width: 180px;">'$DESCRIPTIONMSG'</td><td style="width: 80px;">'$ASSIGNEDMSG'</td><td style="width: 60px;">'$TCPIPMSG'</td><td style="width: 60px;">'$MACADDRESSMSG'</td><td style="width: 80px;">'$SERIAL_KEY'</td><td style="width: 60px;">'$PURCHASE_DATE'</td><td style="width: 60px;">'$VALUEMSG'</td><td style="width: 80px;">'$SUPPLIERMSG'</td><td style="width: 180px;">'$BUDGETMSG'</td></tr>'
else
echo '</tr>'
fi

for ASSETS in `grep -i -l -R $OPTION /opt/karoshi/asset_register/locations/*`
do
ASSET=`basename $ASSETS`
LOCATION=`echo $ASSETS | cut -d"/" -f6`

#Get asset information
source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
assign_asset_labels

echo '<tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_LOCATION_'$LOCATION'_" type="image" class="images" src="'$ICON1'" value=""><span>'$TITLE2'<br>'$LOCATION'</span></a></td><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_edit_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" type="image" class="images" src="'$ICON2'" value=""><span>'$EDITMSG' '$IDENTITY'</span></a></td><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_delete_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" type="image" class="images" src="'$ICON3'" value=""><span>'$DELETEMSG' '$IDENTITY'</span></a></td><td style="vertical-align: top;">

<a class="info" href="javascript:void(0)"><input name="_ACTION_view_LOCATION_'$LOCATION'_ASSETCHOICE_'$ASSETTYPE'_OPTION_filter_" type="image" class="images" src="'$ASSETICON'" value=""><span>'$ASSETLABEL'</span></a>
</td><td style="vertical-align: top;">'

if [ $ASSETTYPE -le 8 ]
then
echo '<a class="info" href="javascript:void(0)"><input name="_ACTION_showlogs_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" type="image" class="images" src="'$ICON17'" value=""><span>Show logs '$IDENTITY'</span></a>'
fi

echo '</td><td style="vertical-align: top;">'$IDENTITY'</td>'

if [ $MOBILE = no ]
then
echo '<td style="vertical-align: top;">'$DESCRIPTION'</td><td style="vertical-align: top;">'$ASSIGNED'</td><td style="vertical-align: top;">
'$TCPIP1' '$TCPIP2' '$TCPIP3'</td><td style="vertical-align: top;">'$MAC1' '$MAC2' '$MAC3'</td><td style="vertical-align: top;">'$SERIAL'</td><td style="vertical-align: top;">'$PURCHASEDATE'</td><td style="vertical-align: top;">'$VALUE'</td><td style="vertical-align: top;">'$SUPPLIER'</td><td style="vertical-align: top;">'$BUDGET'</td></tr>'
else
echo '</tr>'
fi
done
echo '</tbody></table><br>'
fi

##########################
#Import
##########################
if [ $ACTION = import ]
then
echo '<b>Import data</b><br><br>
<input type="image" src="/images/submenus/file/go.gif" name="_ACTION_reallyimport_" value="">
<a href="javascript:history.go(-1)"> <img src="/images/submenus/file/back.gif" alt="back" border="0"></a><br><br>'

echo ''$IDENTITYNAME','$LOCATIONMSG','$ASSETTYPEMSG','$DESCRIPTIONMSG','$TCPIPMSG','$MACADDRESSMSG','$SERIAL_KEY','$PURCHASE_DATE','$VALUEMSG','$SUPPLIERMSG','$BUDGETMSG','$USERNAME'
<textarea cols="150" rows="100" name="_LOCATION_notset_IMPORTDATA_"></textarea>
'
fi

if [ $ACTION = reallyimport ]
then
IMPORTDATA=`echo "$DATA" | cut -s -d: -f25 | sed 's/%2C/,/g' | sed 's/%0D%0A/\n/g'`
TOTALCOUNT=`echo -e "$IMPORTDATA" | wc -l`

echo "<b>"Number of assets to add: $TOTALCOUNT"</b><br><br>"

COUNTER=1
for DATALINE in `echo -e "$IMPORTDATA"`
do
IDENTITY=`echo "$DATALINE" | cut -s -d, -f1 | sed 's/+/ /g' | sed 's/%3A/:/g'`
LOCATION=`echo "$DATALINE" | cut -s -d, -f2 | sed 's/+//g'`
ASSETTYPE=`echo "$DATALINE" | cut -s -d, -f3 | tr -cd '0-9'`
[ $ASSETTYPE'null' = null ] && ASSETTYPE=21
ASSETTYPE=`echo $ASSETTYPE | sed 's/+/ /g'`
DESCRIPTION=`echo "$DATALINE" | cut -s -d, -f4 | sed 's/+/ /g' | sed 's/%3A/:/g'`

TCPIPDATA=`echo "$DATALINE" | cut -s -d, -f5`
TCPIP1=`echo $TCPIPDATA | cut -s -d+ -f1`
TCPIP2=`echo $TCPIPDATA | cut -s -d+ -f2`
TCPIP3=`echo $TCPIPDATA | cut -s -d+ -f3`

MACDATA=`echo "$DATALINE" | cut -s -d, -f6 | sed 's/+/ /g' | sed 's/%3A/:/g'`
MACADDRESS1=`echo $MACDATA | cut -s -d' ' -f1`
MACADDRESS2=`echo $MACDATA | cut -s -d' ' -f2`
MACADDRESS3=`echo $MACDATA | cut -s -d' ' -f3`

SERIALKEY=`echo "$DATALINE" | cut -s -d, -f7`
PURCHASEDATE=`echo "$DATALINE" | cut -s -d, -f8`
VALUE=`echo "$DATALINE" | cut -s -d, -f9 | sed 's/+/ /g' | sed 's/%A3/\&\#163;/g' | sed 's/%C2&#163;/£/g'`
SUPPLIER=`echo "$DATALINE" | cut -s -d, -f10 | sed 's/+/ /g' | sed 's/%3A/:/g'`
BUDGET=`echo "$DATALINE" | cut -s -d, -f11 | sed 's/+/ /g' | sed 's/%3A/:/g'`
USERNAME=`echo "$DATALINE" | cut -s -d, -f12 | sed 's/+/ /g'`

echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2">
<tbody><tr><td style="width: 180px;"><b>'$ADDASSETMSG2'</b></td><td><b>'$COUNTER'/'$TOTALCOUNT'"</b></td></tr>
<tr><td>'$IDENTITYMSG'</td><td>'$IDENTITY'</td></tr>
<tr><td>'$LOCATIONMSG'</td><td>'$LOCATION'</td></tr>
<tr><td>'$ASSETTYPEMSG'</td><td>'$ASSETTYPE'</td></tr>
<tr><td>'$DESCRIPTIONMSG'</td><td>'$DESCRIPTION'</td></tr>
<tr><td>'$TCPIP' 1</td><td>'$TCPIP1'</td></tr>
<tr><td>'$TCPIP' 2</td><td>'$TCPIP2'</td></tr>
<tr><td>'$TCPIP' 3</td><td>'$TCPIP3'</td></tr>
<tr><td>'$MACADDRESS' 1</td><td>'$MACADDRESS1'</td></tr>
<tr><td>'$MACADDRESS' 2</td><td>'$MACADDRESS2'</td></tr>
<tr><td>'$MACADDRESS' 3</td><td>'$MACADDRESS3'</td></tr>
<tr><td>'$SERIALKEY'</td><td>'$SERIALKEY'</td></tr>
<tr><td>'$PURCHASE_DATE'</td><td>'$PURCHASEDATE'</td></tr>
<tr><td>'$VALUEMSG'</td><td>'$VALUE'</td></tr>
<tr><td>'$SUPPLIERMSG'</td><td>'$SUPPLIER'</td></tr>
<tr><td>'$BUDGETMSG'</td><td>'$BUDGET'</td></tr>
<tr><td>'$USERNAME'</td><td>'$USERNAME'</td></tr>
</tbody></table><br>
'
#######################
#Make sure that the location exists
######################
ROOMCHECK=`grep -c -w $LOCATION /var/lib/samba/netlogon/locations.txt`
if [ $ROOMCHECK = 0 ]
then
#Modify locations.txt
echo $LOCATION >> /var/lib/samba/netlogon/locations.txt
sort -f /var/lib/samba/netlogon/locations.txt > /var/lib/samba/netlogon/locations.tmp
sed -i '/^$/d' /var/lib/samba/netlogon/locations.tmp
mv -f /var/lib/samba/netlogon/locations.tmp /var/lib/samba/netlogon/locations.txt
echo >> /var/lib/samba/netlogon/locations.txt
rm -f /var/lib/samba/netlogon/locations.tmp

###########################
#Modify wsetup.kix
###########################
KIXLOCATIONLIST=`cat /var/lib/samba/netlogon/locations.txt | tr '\n' ','  | sed 's/,,/,/g' ; echo NoGroup`
COMBOXBOX1LINENO=`grep -n '$'ComboBox1.List /var/lib/samba/netlogon/kix/WSsetup.kix | cut -d: -f1`
sed $COMBOXBOX1LINENO'c'\$ComboBox1.List" "=" "$KIXLOCATIONLIST /var/lib/samba/netlogon/kix/WSsetup.kix > /var/lib/samba/netlogon/kix/WSsetup.kix1
rm -f /var/lib/samba/netlogon/kix/WSsetup.kix
mv /var/lib/samba/netlogon/kix/WSsetup.kix1 /var/lib/samba/netlogon/kix/WSsetup.kix
chmod 0644 /var/lib/samba/netlogon/kix/WSsetup.kix
fi

#########################
#Add in asset
#########################
get_asset_number
echo `date`: asset_register_view - adding $IDENTITY to $LOCATION by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
write_asset_data
#Delete lock file
rm -f /opt/karoshi/asset_register/.asset_lock

let COUNTER=$COUNTER+1
done
#Show main page
#View logs
echo '</form><form action="asset_register_view.cgi" id="foo" method="post">
<input name="_LOCATION_showchoice_" value="" type="hidden">
</form>

<script type="text/javascript">
    function myfunc () {
        var frm = document.getElementById("foo");
        frm.submit();
    }
    window.onload = myfunc;
</script>'

fi

exit

