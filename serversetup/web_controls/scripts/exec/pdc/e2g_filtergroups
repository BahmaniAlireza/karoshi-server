#!/bin/bash
#Copyright (C) 2014 Paul Sharrad

#This file is part of Karoshi Server.
#
#Karoshi Server is free software: you can redistribute it and/or modify
#it under the terms of the GNU Affero General Public License as published by
#the Free Software Foundation, either version 3 of the License, or
#(at your option) any later version.
#
#Karoshi Server is distributed in the hope that it will be useful,
#but WITHOUT ANY WARRANTY; without even the implied warranty of
#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#GNU Affero General Public License for more details.
#
#You should have received a copy of the GNU Affero General Public License
#along with Karoshi Server.  If not, see <http://www.gnu.org/licenses/>.

#
#The Karoshi Team can be contacted at: 
#mpsharrad@karoshi.org.uk
#jsharrad@karoshi.org.uk

#
#Website: http://www.karoshi.org.uk
LOG_DATE=`date +%F`
ICON1=/images/submenus/internet/remove_group.png

########################
#Check md5checksum
########################
if ! test -f /opt/karoshi/web_controls/checksums/admin_checksums/e2g_filtergroups_cgi
then
echo `date`: e2g_filtergroups - No admin MD5Checksum >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi
source /opt/karoshi/web_controls/checksums/admin_checksums/e2g_filtergroups_cgi
MD5SUM=`md5sum /var/www/cgi-bin_karoshi/admin/e2g_filtergroups.cgi | cut -d' ' -f1`
[ $MD5SUM'null' = null ] && MD5SUM=not_set
if [ $MD5SUM'check' != $e2g_filtergroups_cgi'check' ]
then
echo `date`: e2g_filtergroups - Incorrect admin MD5Checksum >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi

########################
#Get variables
########################
numArgs=$#
if [ $numArgs != 0 ]
then
echo `date`: e2g_filtergroups - incorrect number of arguments >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi

read DATA
DATA=`echo $DATA | tr -cd 'A-Za-z0-9\._:\-+'`
if [ $DATA'null' = null ]
then
echo `date`: e2g_filtergroups - no data >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi
REMOTE_USER=`echo "$DATA" | cut -s -d: -f1`
REMOTE_ADDR=`echo "$DATA" | cut -s -d: -f2`
REMOTE_MD5=`echo "$DATA" | cut -s -d: -f3`
ACTION=`echo "$DATA" | cut -s -d: -f4`
FILTERNAME=`echo "$DATA" | cut -s -d: -f5`
FILTERLABEL=`echo "$DATA" | cut -s -d: -f6`
FILTERDESC=`echo "$DATA" | cut -s -d: -f7`
FILTERCLONE=`echo "$DATA" | cut -s -d: -f8`
FILTERGROUP=`echo "$DATA" | cut -s -d: -f9`

PROXYSERVER=`sed -n 1,1p /opt/karoshi/server_network/proxyserver`

########################
#Check data
########################
if [ $REMOTE_MD5'check' != $MD5SUM'check' ]
then
	echo `date`: e2g_filtergroups - Not called by e2g_filtergroups.cgi >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	exit 101
fi
if [ -z "$REMOTE_USER" ]
then
	echo `date`: e2g_filtergroups - Blank remote user >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	exit 101
fi
if [ -z "$REMOTE_ADDR" ]
then
	echo `date`: e2g_filtergroups - Blank remote tcpip address >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	exit 101
fi
if [ -z "$ACTION" ]
then
	echo `date`: e2g_filtergroups - Blank action by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	exit 101
fi
if [ "$ACTION" = reallyadd ]
then
	if [ -z "$FILTERLABEL" ]
	then
		echo `date`: e2g_filtergroups - Blank filter label by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		exit 101
	fi
	if [ -z "$FILTERDESC" ]
	then
		echo `date`: e2g_filtergroups - Blank fiter description by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		exit 101
	fi
	if [ -z "$FILTERCLONE" ]
	then
		echo `date`: e2g_filtergroups - Blank filter clone by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		exit 101
	fi
fi

if [ "$ACTION" = editlabel ]
then
	if [ -z "$FILTERNAME" ]
	then
		echo `date`: e2g_filtergroups - Blank filtername by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		exit 101
	fi
fi

if [ $ACTION = reallyeditlabel ]
then
	if [ -z "$FILTERDESC" ]
	then
		echo `date`: e2g_filtergroups - Blank filter description by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		exit 101
	fi
	if [ -z "$FILTERLABEL" ]
	then
		echo `date`: e2g_filtergroups - Blank filter label by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		exit 101
	fi	

fi

if [ `grep -c ^$REMOTE_USER: /opt/karoshi/web_controls/web_access_admin` != 1 ]
then
echo `date`: e2g_filtergroups - access denied to $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
exit 101
fi

##########################
#Language
##########################
LANGCHOICE=englishuk
STYLESHEET=defaultstyle.css
[ -f /opt/karoshi/web_controls/user_prefs/$REMOTE_USER ] && source /opt/karoshi/web_controls/user_prefs/$REMOTE_USER
[ -f /opt/karoshi/web_controls/language/$LANGCHOICE/internet/e2g_filtergroups ] || LANGCHOICE=englishuk
source /opt/karoshi/web_controls/language/$LANGCHOICE/internet/e2g_filtergroups
[ -f /opt/karoshi/web_controls/language/$LANGCHOICE/all ] || LANGCHOICE=englishuk
source /opt/karoshi/web_controls/language/$LANGCHOICE/all

source /opt/karoshi/server_network/domain_information/domain_name

function showtitle {
echo '<table class="standard" style="text-align: left;" border="0" cellpadding="2" cellspacing="2">
<tr><td style="width: 180px; vertical-align: top;"><div class="sectiontitle">'$TITLE'</div></td><td style="vertical-align: top;">
<input name="_ACTION_view_" type="submit" class="button" value="'$VIEWFGROUPS'">
</td>
<td style="vertical-align: top;"><a class="info" target="_blank" href="http://www.linuxschools.com/karoshi/documentation/wiki/index.php?title=DNS"><img class="images" alt="" src="/images/help/info.png"><span>'$HELPMSG'</span></a></td>
</tr></tbody></table><br></div><div id="infobox">'
}

function viewfilters {
#Show add filtergroup button
echo '<table class="standard" style="text-align: left;" border="0" cellpadding="2" cellspacing="2">
<tr><td style="vertical-align: top;"><div class="sectiontitle">'$TITLE1'</div></td>
<td style="vertical-align: top;">
<input name="_ACTION_add_" type="submit" class="button" value="'$ADDFGROUP'">
</td>
<td style="vertical-align: top;"><a class="info" target="_blank" href="http://www.linuxschools.com/karoshi/documentation/wiki/index.php?title=DNS"><img class="images" alt="" src="/images/help/info.png"><span>'$HELPMSG1'</span></a></td></tr></tbody></table><br>'

#Show existing filtergroups

echo "<table class=\"standard\" style=\"text-align: left;\" border=\"0\" cellpadding=\"2\" cellspacing=\"2\">
<tr><td style=\"width: 40px;\"><b>$FILTERNAMEMSG</b></td><td style=\"width: 120px;\"><b>$FILTERLABELMSG</b></td><td style=\"width: 140px;\"><b>$FILTERDESCMSG</b></td><td style=\"width: 120px;\"><b>$ASSIGNEDGROUPSMSG</b></td></tr>
"

if [ $PROXYSERVER = `hostname-fqdn` ]
then
	for FILTERGROUPS in /etc/e2guardian/lists/filtergroups/*
	do
		FILTERGROUP=`basename $FILTERGROUPS`
		source /etc/e2guardian/lists/filtergroups/$FILTERGROUP/details
		echo "<tr><td style=\"height: 40px;\" valign=\"top\">$FILTERGROUP</td><td valign=\"top\">$FILTERLABEL</td><td valign=\"top\">$FILTERDESC</td><td valign=\"top\">"

		#Get list of assigned groups

		if [ $FILTERGROUP = f1 ]
		then
			echo $DEFAULTGROUPMSG
		else
			if [ -d /etc/e2guardian/lists/filtergroups/$FILTERGROUP/assigned_groups ]
			then
				for ASSIGNEDGROUPS in /etc/e2guardian/lists/filtergroups/$FILTERGROUP/assigned_groups/*
				do
					ASSIGNEDGROUP=`basename $ASSIGNEDGROUPS`
					echo $ASSIGNEDGROUP"<br>"
				done
			fi
		fi
		#Show actions for the filter groups
		if [ $FILTERGROUP != f1 ]
		then
			echo "<td style=\"vertical-align: top;\"><input name=\"_ACTION_editfiltergroup_FILTERNAME_"$FILTERGROUP"_\" type=\"submit\" class=\"button\" value=\"$EDITFILTERGROUPMSG\"></td><td style=\"vertical-align: top;\"><input name=\"_ACTION_filtercategories_FILTERNAME_"$FILTERGROUP"_\" type=\"submit\" class=\"button\" value=\"$FILTERLISTSMSG\"></td><td style=\"vertical-align: top;\"><input name=\"_ACTION_deletefiltergroup_FILTERNAME_"$FILTERGROUP"_\" type=\"submit\" class=\"button\" value=\"$DELETEFILTERGROUPMSG\"></td>"
		else
		echo "<td></td><td style=\"vertical-align: top;\"><input name=\"_ACTION_filtercategories_FILTERNAME_"$FILTERGROUP"_\" type=\"submit\" class=\"button\" value=\"$FILTERLISTSMSG\"></td>"
		fi
		echo "</tr>"
	done
else
ssh -o PasswordAuthentication=no -o ConnectTimeout=3 $PROXYSERVER '
	for FILTERGROUPS in /etc/e2guardian/lists/filtergroups/*
	do
		FILTERGROUP=`basename $FILTERGROUPS`
		source /etc/e2guardian/lists/filtergroups/$FILTERGROUP/details
		echo "<tr><td style=\"height: 40px;\" valign=\"top\">$FILTERGROUP</td><td valign=\"top\">$FILTERLABEL</td><td valign=\"top\">$FILTERDESC</td><td valign=\"top\">"

		#Get list of assigned groups

		if [ $FILTERGROUP = f1 ]
		then
			echo $DEFAULTGROUPMSG
		else
			if [ -d /etc/e2guardian/lists/filtergroups/$FILTERGROUP/assigned_groups ]
			then
				for ASSIGNEDGROUPS in /etc/e2guardian/lists/filtergroups/$FILTERGROUP/assigned_groups/*
				do
					ASSIGNEDGROUP=`basename $ASSIGNEDGROUPS`
					echo $ASSIGNEDGROUP"<br>"
				done
			fi
		fi
		#Show actions for the filter groups
		if [ $FILTERGROUP != f1 ]
		then
			echo "<td style=\"vertical-align: top;\"><input name=\"_ACTION_editfiltergroup_FILTERNAME_"$FILTERGROUP"_\" type=\"submit\" class=\"button\" value=\"'$EDITFILTERGROUPMSG'\"></td><td style=\"vertical-align: top;\"><input name=\"_ACTION_filtercategories_FILTERNAME_"$FILTERGROUP"_\" type=\"submit\" class=\"button\" value=\"'$FILTERLISTSMSG'\"></td><td style=\"vertical-align: top;\"><input name=\"_ACTION_deletefiltergroup_FILTERNAME_"$FILTERGROUP"_\" type=\"submit\" class=\"button\" value=\"'$DELETEFILTERGROUPMSG'\"></td>"
		else
		echo "<td></td><td style=\"vertical-align: top;\"><input name=\"_ACTION_filtercategories_FILTERNAME_"$FILTERGROUP"_\" type=\"submit\" class=\"button\" value=\"'$FILTERLISTSMSG'\"></td>"
		fi
		echo "</tr>"
	done
'
fi
echo "</tbody></table>"
}

function reallyeditlabels {
FILTERLABEL=`echo $FILTERLABEL | sed "s/+/ /g"`
FILTERDESC=`echo $FILTERDESC | sed "s/+/ /g"`

if [ $PROXYSERVER = `hostname-fqdn` ]
then
	echo "FILTERLABEL=\"$FILTERLABEL\"" > /etc/e2guardian/lists/filtergroups/$FILTERNAME/details
	echo "FILTERDESC=\"$FILTERDESC\"" >> /etc/e2guardian/lists/filtergroups/$FILTERNAME/details
else
	ssh -o PasswordAuthentication=no -o ConnectTimeout=3 $PROXYSERVER '
	echo "FILTERLABEL=\"'$FILTERLABEL'\"" > /etc/e2guardian/lists/filtergroups/'$FILTERNAME'/details
	echo "FILTERDESC=\"'$FILTERDESC'\"" >> /etc/e2guardian/lists/filtergroups/'$FILTERNAME'/details
'
fi
}

function addfiltergroup {
#Show view filtergroup button
TITLE="$TITLE2"
HELPMSG="$HELPMSG2"
showtitle

echo ''$FILTERWARNINGMSG'<br><br><input type="hidden" name="_ACTION_" value="reallyadd"><table class="standard" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
<tr><td style="width: 180px;">'$FILTERLABELMSG'</td><td><input tabindex= "1" name="_FILTERLABEL_" style="width: 200px;" size="20" type="text"></td></tr>
<tr><td style="width: 180px;">'$FILTERDESCMSG'</td><td><input tabindex= "1" name="_FILTERDESC_" style="width: 200px;" size="20" type="text"></td></tr>
<tr><td style="width: 180px;">'$FILTERCLONEMSG'</td><td><select name="_FILTERCLONE_" style="width: 200px;">'

if [ $PROXYSERVER = `hostname-fqdn` ]
then
	for FILTERGROUPS in /etc/e2guardian/lists/filtergroups/*
	do
		FILTERGROUP=`basename $FILTERGROUPS`
		echo "<option value=\"$FILTERGROUP\" $FILTERGROUP>$FILTERGROUP</option>"
	done
else
	ssh -o PasswordAuthentication=no -o ConnectTimeout=3 $PROXYSERVER '
	for FILTERGROUPS in /etc/e2guardian/lists/filtergroups/*
	do
		FILTERGROUP=`basename $FILTERGROUPS`
		echo "<option value=\"$FILTERGROUP\" $FILTERGROUP>$FILTERGROUP</option>"
	done
	'
fi
echo '</select></tbody></table><br><br><input value="'$SUBMITMSG'" class="button" type="submit"> <input value="'$RESETMSG'" class="button" type="reset">
'

}

function reallyaddfiltergroup {
#Get name of new filter group
if [ $PROXYSERVER = `hostname-fqdn` ]
then
FILTERCOUNT=`ls -1 /etc/e2guardian/lists/filtergroups/ | wc -l`
else
FILTERCOUNT=`ssh -o PasswordAuthentication=no -o ConnectTimeout=3 $PROXYSERVER 'ls -1 /etc/e2guardian/lists/filtergroups/ | wc -l'`
fi
let FILTERCOUNT=$FILTERCOUNT+1

echo `date`: e2g_filtergroups - adding new filter group f$FILTERCOUNT by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE

if [ $PROXYSERVER = `hostname-fqdn` ]
then
	#Get name of new filter group
	FILTERCOUNT=`ls -1 /etc/e2guardian/lists/filtergroups/ | wc -l`
	let FILTERCOUNT=$FILTERCOUNT+1

	#Copy filter group config folder
	cp -f -R /etc/e2guardian/lists/filtergroups/$FILTERCLONE /etc/e2guardian/lists/filtergroups/f$FILTERCOUNT

	#Copy e2guardian config file
	cp -f /etc/e2guardian/e2guardian$FILTERCLONE.conf /etc/e2guardian/e2guardianf$FILTERCOUNT.conf
	#Edit e2guardian config file to look at the correct filter folder
	sed -i "s/$FILTERCLONE/f$FILTERCOUNT/g" /etc/e2guardian/e2guardianf$FILTERCOUNT.conf

	#Modifiy e2guardian.conf for correct number of filters
	FILTERLINENO=`grep -n ^"filtergroups =" /etc/e2guardian/e2guardian.conf | cut -d: -f1`
	sed -i $FILTERLINENO"c""filtergroups = $FILTERCOUNT" /etc/e2guardian/e2guardian.conf

	#Restart e2guardian
	source /opt/karoshi/serversetup/variables/distro
	/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/e2guardian_stop 1>/dev/null
	sleep 1
	/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/e2guardian_start 1>/dev/null
else
ssh -o PasswordAuthentication=no -o ConnectTimeout=3 $PROXYSERVER '

	#Copy filter group config folder
	cp -f -R /etc/e2guardian/lists/filtergroups/'$FILTERCLONE' /etc/e2guardian/lists/filtergroups/f'$FILTERCOUNT'

	#Copy e2guardian config file
	cp -f /etc/e2guardian/e2guardian'$FILTERCLONE'.conf /etc/e2guardian/e2guardianf'$FILTERCOUNT'.conf
	#Edit e2guardian config file to look at the correct filter folder
	sed -i "s/'$FILTERCLONE'/f'$FILTERCOUNT'/g" /etc/e2guardian/e2guardianf'$FILTERCOUNT'.conf

	#Modifiy e2guardian.conf for correct number of filters
	FILTERLINENO=`grep -n ^"filtergroups =" /etc/e2guardian/e2guardian.conf | cut -d: -f1`
	sed -i $FILTERLINENO"c""filtergroups = '$FILTERCOUNT'" /etc/e2guardian/e2guardian.conf

	#Restart e2guardian
	source /opt/karoshi/serversetup/variables/distro
	/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/e2guardian_stop 1>/dev/null
	sleep 1
	/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/e2guardian_start 1>/dev/null
'
fi

#Modify details file
FILTERNAME=f$FILTERCOUNT
reallyeditlabels
}

function deletefiltergroup {
#Show view filtergroup button
TITLE="$TITLE4"
HELPMSG="$HELPMSG4"
showtitle

if [ $PROXYSERVER = `hostname-fqdn` ]
then
	source /etc/e2guardian/lists/filtergroups/$FILTERNAME/details
else
	source <(ssh -o PasswordAuthentication=no -o ConnectTimeout=3 $PROXYSERVER cat /etc/e2guardian/lists/filtergroups/$FILTERNAME/details)
fi
echo '
<table class="standard" style="text-align: left;" border="0" cellpadding="2" cellspacing="2">
<tr><td style="width: 180px;">'$FILTERNAMEMSG'</td><td>'$FILTERNAME'</td></tr>
<tr><td>'$FILTERLABELMSG'</td><td>'$FILTERLABEL'</td></tr>
<tr><td>'$FILTERDESCMSG'</td><td>'$FILTERDESC'</td></tr></tbody></table><br>
'$CONFIRMDELETEMSG'<br><br><input type="hidden" name="_ACTION_" value="reallydelete"><br><input type="hidden" name="_FILTERNAME_" value="'$FILTERNAME'"><input value="'$SUBMITMSG'" class="button" type="submit">'
}

function reallydelete {
echo `date`: e2g_filtergroups - deleting filter group $FILTERNAME by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
if [ $PROXYSERVER = `hostname-fqdn` ]
then
	#Delete filter folder
	rm -f -R /etc/e2guardian/lists/filtergroups/$FILTERNAME
	#Delete e2guardian config file
	rm -f /etc/e2guardian/e2guardian$FILTERNAME.conf
	#Modify e2guardian.conf with correct filter count.
	FILTERCOUNT=`ls -1 /etc/e2guardian/lists/filtergroups/ | wc -l`
	FILTERLINENO=`grep -n ^"filtergroups =" /etc/e2guardian/e2guardian.conf | cut -d: -f1`
	sed -i $FILTERLINENO"c""filtergroups = $FILTERCOUNT" /etc/e2guardian/e2guardian.conf

	#Rename all filter groups so that they are in sequence
	COUNTER=1
	for FILTERGROUPS in /etc/e2guardian/lists/filtergroups/*
	do
		FILTERGROUP=`basename $FILTERGROUPS`
		#Check that the filtergroup name is correct
		if [ $FILTERGROUP != f$COUNTER ]
		then
			mv /etc/e2guardian/lists/filtergroups/$FILTERGROUP /etc/e2guardian/lists/filtergroups/f$COUNTER
			sed -i "s/$FILTERGROUP/f$COUNTER/g" /etc/e2guardian/e2guardian$FILTERGROUP.conf
			mv /etc/e2guardian/e2guardian$FILTERGROUP.conf /etc/e2guardian/e2guardianf$COUNTER.conf
		fi
		let COUNTER=$COUNTER+1
	done 
	#Regenerate filter lists
	/opt/karoshi/"useful scripts"/dgupdatefilterlist
	#Restart e2guardian
	source /opt/karoshi/serversetup/variables/distro
	/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/e2guardian_stop 1>/dev/null
	sleep 1
	/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/e2guardian_start 1>/dev/null
else
ssh -o PasswordAuthentication=no -o ConnectTimeout=3 $PROXYSERVER '
	#Delete filter folder
	rm -f -R /etc/e2guardian/lists/filtergroups/'$FILTERNAME'
	#Delete e2guardian config file
	rm -f /etc/e2guardian/e2guardian'$FILTERNAME'.conf
	#Modify e2guardian.conf with correct filter count.
	FILTERCOUNT=`ls -1 /etc/e2guardian/lists/filtergroups/ | wc -l`
	FILTERLINENO=`grep -n ^"filtergroups =" /etc/e2guardian/e2guardian.conf | cut -d: -f1`
	sed -i $FILTERLINENO"c""filtergroups = $FILTERCOUNT" /etc/e2guardian/e2guardian.conf

	#Rename all filter groups so that they are in sequence
	COUNTER=1
	for FILTERGROUPS in /etc/e2guardian/lists/filtergroups/*
	do
		FILTERGROUP=`basename $FILTERGROUPS`
		#Check that the filtergroup name is correct
		if [ $FILTERGROUP != f$COUNTER ]
		then
			mv /etc/e2guardian/lists/filtergroups/$FILTERGROUP /etc/e2guardian/lists/filtergroups/f$COUNTER
			sed -i "s/$FILTERGROUP/f$COUNTER/g" /etc/e2guardian/e2guardian$FILTERGROUP.conf
			mv /etc/e2guardian/e2guardian$FILTERGROUP.conf /etc/e2guardian/e2guardianf$COUNTER.conf
		fi
		let COUNTER=$COUNTER+1
	done 
	#Regenerate filter lists
	/opt/karoshi/"useful scripts"/dgupdatefilterlist
	#Restart e2guardian
	source /opt/karoshi/serversetup/variables/distro
	/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/e2guardian_stop 1>/dev/null
	sleep 1
	/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/e2guardian_start 1>/dev/null
'
fi
}

function editfiltergroup {

TITLE="$TITLE5"
HELPMSG="$HELPMSG5"
showtitle

if [ $PROXYSERVER = `hostname-fqdn` ]
then
	source /etc/e2guardian/lists/filtergroups/$FILTERNAME/details
else
	source <(ssh -o PasswordAuthentication=no -o ConnectTimeout=3 $PROXYSERVER cat /etc/e2guardian/lists/filtergroups/$FILTERNAME/details)
fi

#Show details for the group

echo "<input type=\"hidden\" name=\"_FILTERNAME_\" value=\"$FILTERNAME\"><input type=\"hidden\" name=\"_ACTION_\" value=\"reallyeditlable\"><table class=\"standard\" style=\"text-align: left;\" border=\"0\" cellpadding=\"2\" cellspacing=\"2\"><tbody>
<tr><td style=\"width: 180px;\">$FILTERNAMEMSG</td><td>$FILTERNAME</td></tr><td style=\"width: 180px;\">$FILTERLABELMSG</td><td><input tabindex= \"1\" value=\"$FILTERLABEL\" name=\"_FILTERLABEL_\" style=\"width: 200px;\" size=\"20\" type=\"text\"></td><td><input value=\"$SUBMITMSG\" class=\"button\" type=\"submit\"></td></tr>
<tr><td>$FILTERDESCMSG</td><td><input tabindex= \"2\" value=\"$FILTERDESC\" name=\"_FILTERDESC_\" style=\"width: 200px;\" size=\"20\" type=\"text\"></td></tr></tbody></table><br><br>"

echo '</form><form name="myform" action="/cgi-bin/admin/e2g_filtergroups.cgi" method="post">'

#Show option to add in a group
echo "<input type=\"hidden\" name=\"_FILTERNAME_\" value=\"$FILTERNAME\"><input type=\"hidden\" name=\"_ACTION_\" value=\"reallyaddgroup\">"
echo "<table class=\"standard\" style=\"text-align: left;\" border=\"0\" cellpadding=\"2\" cellspacing=\"2\">
<tr><td style=\"width: 180px;\"><b>$ADDUSERGROUPMSG</b></td></tr><tr><td>$GROUPMSG</td><td>"

/opt/karoshi/web_controls/group_dropdown_list | sed 's/_GROUP_/_FILTERGROUP_/g'

echo "</td><td><input value="$SUBMITMSG" class=\"button\" type=\"submit\"></td></tr></tbody></table><br>"

echo '</form><form name="myform" action="/cgi-bin/admin/e2g_filtergroups.cgi" method="post">'


#Show any existing groups that have been assigned.
if [ $PROXYSERVER = `hostname-fqdn` ]
then
	if [ -d /etc/e2guardian/lists/filtergroups/$FILTERNAME/assigned_groups ]
	then
		echo "<table class=\"standard\" style=\"text-align: left;\" border=\"0\" cellpadding=\"2\" cellspacing=\"2\"><tr><td style=\"width: 180px;\"><b>$ASSIGNEDUSERGROUPSMSG</b></td><td><b>$REMOVEMSG</b></td></tr>
		"
		for FILTERGROUPS in /etc/e2guardian/lists/filtergroups/$FILTERNAME/assigned_groups/*
		do
			FILTERGROUP=`basename $FILTERGROUPS`
			echo "<tr><td style=\"width: 180px;\">$FILTERGROUP</td><td><a class=\"info\" href=\"javascript:void(0)\"><input name=\"_ACTION_removegroup_FILTERNAME_$FILTERNAME"_"FILTERGROUP"_"$FILTERGROUP"_"\" type=\"image\" class=\"images\" src=\"$ICON1\" value=\"\"><span>$FILTERGROUP<br>$REMOVEMSG</span></a></td></tr>"
			done
		echo "</tbody></table>"
	fi
else
ssh -o PasswordAuthentication=no -o ConnectTimeout=3 $PROXYSERVER '
	if [ -d /etc/e2guardian/lists/filtergroups/'$FILTERNAME'/assigned_groups ]
	then
		echo "<table class=\"standard\" style=\"text-align: left;\" border=\"0\" cellpadding=\"2\" cellspacing=\"2\"><tr><td style=\"width: 180px;\"><b>'$ASSIGNEDUSERGROUPSMSG'</b></td><td><b>'$REMOVEMSG'</b></td></tr>
		"
		for FILTERGROUPS in /etc/e2guardian/lists/filtergroups/'$FILTERNAME'/assigned_groups/*
		do
			FILTERGROUP=`basename $FILTERGROUPS`
			echo "<tr><td style=\"width: 180px;\">$FILTERGROUP</td><td><a class=\"info\" href=\"javascript:void(0)\"><input name=\"_ACTION_removegroup_FILTERNAME_'$FILTERNAME'"_"FILTERGROUP"_"$FILTERGROUP"_"\" type=\"image\" class=\"images\" src=\"'$ICON1'\" value=\"\"><span>$FILTERGROUP<br>'$REMOVEMSG'</span></a></td></tr>"
			done
		echo "</tbody></table>"
	fi
'
fi
}

function removegroup {
echo `date`: e2g_filtergroups - removing $FILTERGROUP from filtergroup $FILTERNAME by  $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
if [ $PROXYSERVER = `hostname-fqdn` ]
then
	#Remove filtergroup flag file
	[ -f /etc/e2guardian/lists/filtergroups/$FILTERNAME/assigned_groups/$FILTERGROUP ] && rm -f /etc/e2guardian/lists/filtergroups/$FILTERNAME/assigned_groups/$FILTERGROUP

	#Remove assigned_groups folder if it is empty
	[ `ls -1 /etc/e2guardian/lists/filtergroups/$FILTERNAME/assigned_groups | wc -l` = 0 ] && rm -f -R /etc/e2guardian/lists/filtergroups/$FILTERNAME/assigned_groups

	#Regenerate filter lists
	/opt/karoshi/"useful scripts"/dgupdatefilterlist
else
ssh -o PasswordAuthentication=no -o ConnectTimeout=3 $PROXYSERVER '
	#Remove filtergroup flag file
	[ -f /etc/e2guardian/lists/filtergroups/'$FILTERNAME'/assigned_groups/'$FILTERGROUP' ] && rm -f /etc/e2guardian/lists/filtergroups/'$FILTERNAME'/assigned_groups/'$FILTERGROUP'

	#Remove assigned_groups folder if it is empty
	[ `ls -1 /etc/e2guardian/lists/filtergroups/'$FILTERNAME'/assigned_groups | wc -l` = 0 ] && rm -f -R /etc/e2guardian/lists/filtergroups/'$FILTERNAME'/assigned_groups

	#Regenerate filter lists
	/opt/karoshi/"useful scripts"/dgupdatefilterlist
'
fi
}

function reallyaddgroup {
echo `date`: e2g_filtergroups - adding $FILTERGROUP to filtergroup $FILTERNAME by  $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE

if [ $PROXYSERVER = `hostname-fqdn` ]
then
#Create flag file
[ ! -d /etc/e2guardian/lists/filtergroups/$FILTERNAME/assigned_groups ] && mkdir -p /etc/e2guardian/lists/filtergroups/$FILTERNAME/assigned_groups
touch /etc/e2guardian/lists/filtergroups/$FILTERNAME/assigned_groups/$FILTERGROUP

#Remove flag file from any other filtergroup.
for FILTERGROUPS in /etc/e2guardian/lists/filtergroups/*
do
	GROUP=`basename $FILTERGROUPS`
	if [ $GROUP != $FILTERNAME ]
	then
		if [ -d /etc/e2guardian/lists/filtergroups/$GROUP/assigned_groups ]
		then
			[ -f /etc/e2guardian/lists/filtergroups/$GROUP/assigned_groups/$FILTERGROUP ] && rm -f /etc/e2guardian/lists/filtergroups/$GROUP/assigned_groups/$FILTERGROUP

			#Remove assigned_groups folder if it is empty
			[ `ls -1 /etc/e2guardian/lists/filtergroups/$GROUP/assigned_groups | wc -l` = 0 ] && rm -f -R /etc/e2guardian/lists/filtergroups/$GROUP/assigned_groups
		fi
	fi
done

#Regenerate filter lists
/opt/karoshi/"useful scripts"/dgupdatefilterlist
else
ssh -o PasswordAuthentication=no -o ConnectTimeout=3 $PROXYSERVER '
#Create flag file
[ ! -d /etc/e2guardian/lists/filtergroups/'$FILTERNAME'/assigned_groups ] && mkdir -p /etc/e2guardian/lists/filtergroups/'$FILTERNAME'/assigned_groups
touch /etc/e2guardian/lists/filtergroups/'$FILTERNAME'/assigned_groups/'$FILTERGROUP'

#Remove flag file from any other filtergroup.
for FILTERGROUPS in /etc/e2guardian/lists/filtergroups/*
do
	GROUP=`basename $FILTERGROUPS`
	if [ $GROUP != '$FILTERNAME' ]
	then
		if [ -d /etc/e2guardian/lists/filtergroups/$GROUP/assigned_groups ]
		then
			[ -f /etc/e2guardian/lists/filtergroups/$GROUP/assigned_groups/'$FILTERGROUP' ] && rm -f /etc/e2guardian/lists/filtergroups/$GROUP/assigned_groups/'$FILTERGROUP'

			#Remove assigned_groups folder if it is empty
			[ `ls -1 /etc/e2guardian/lists/filtergroups/$GROUP/assigned_groups | wc -l` = 0 ] && rm -f -R /etc/e2guardian/lists/filtergroups/$GROUP/assigned_groups
		fi
	fi
done

#Regenerate filter lists
/opt/karoshi/"useful scripts"/dgupdatefilterlist
'
fi
}
 
[ "$ACTION" = reallyeditlable ] && ( reallyeditlabels ; editfiltergroup )
[ "$ACTION" = add ] && addfiltergroup 
[ "$ACTION" = reallyadd ] && ( reallyaddfiltergroup ; viewfilters )
[ "$ACTION" = deletefiltergroup ] && deletefiltergroup
[ "$ACTION" = reallydelete ] && ( reallydelete ; viewfilters )
[ "$ACTION" = editfiltergroup ] && editfiltergroup
[ "$ACTION" = removegroup ] && ( removegroup ; editfiltergroup )
[ "$ACTION" = reallyaddgroup ] && ( reallyaddgroup ; editfiltergroup )
[ "$ACTION" = view ] && viewfilters

exit















############################
#Create user home area on extra fileserver
############################
if [ $PROXYSERVER != `hostname-fqdn` ]
then
ssh -o PasswordAuthentication=no -o ConnectTimeout=3 $PROXYSERVER '
[ ! -d '$HOMEPATH''/''$NEWUSERNAME' ] && mkdir -p '$HOMEPATH''/''$NEWUSERNAME'
chown -R '$USERID':root '$HOMEPATH''/''$NEWUSERNAME'
chmod -R 0600 '$HOMEPATH''/''$NEWUSERNAME'
[ `echo '$HOMEPATH' | grep -c students` -gt 0 ] && setfacl -Rm group:staff:r-x,d:group:staff:r-x '$HOMEPATH'/'$NEWUSERNAME'/
setfacl -m u::rwx,g::---,o::---,m::r-x '$HOMEPATH'/'$NEWUSERNAME'/
'

